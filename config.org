#+TITLE: PrawnFarmerDev Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/init.el

* Early Init (Performance & Warning Suppression)
This section creates an early-init.el file for startup optimizations and warning suppression.

#+begin_src emacs-lisp :tangle ~/.emacs.d/early-init.el
;; early-init.el --- Early initialization -*- lexical-binding: t -*-

;; Increase GC threshold during startup for faster loading
(setq gc-cons-threshold most-positive-fixnum)

;; Suppress compiler warnings for deprecated cl package (from packages like Evil)
(setq byte-compile-warnings '(not cl-functions obsolete))

;; Don't show warnings about obsolete functions during package loading
(setq warning-minimum-level :error)

;; Restore GC threshold after startup
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 100 1024 1024)))) ; 100MB

;; Disable package.el in favor of straight.el or manual management
;; (We'll enable it in init.el)
(setq package-enable-at-startup nil)

;; Faster to disable these here than in init.el
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)

;;; early-init.el ends here
#+end_src

* System Requirements
Before using this configuration, install the following packages on your Arch system:

** Core tools
#+begin_src bash :tangle no
# Package manager and Git
sudo pacman -S git ripgrep

# Language servers
sudo pacman -S python-lsp-server gopls clang typescript-language-server

# Debuggers (for dape)
sudo pacman -S gdb lldb delve  # C/C++, Go debuggers
#+end_src

** AUR packages (using yay or paru)
#+begin_src bash :tangle no
# JSON language server
yay -S vscode-json-languageserver

# YAML language server
yay -S yaml-language-server-bin

# Terraform language server
yay -S terraform-ls

# Dockerfile language server
yay -S dockerfile-language-server-bin

# GitHub CLI (optional, for project creation)
yay -S github-cli
#+end_src

** Alternative installation via npm
#+begin_src bash :tangle no
# If you prefer npm installation:
npm install -g vscode-langservers-extracted  # includes json-languageserver
npm install -g yaml-language-server
npm install -g @ansible/ansible-language-server  # if you use Ansible
#+end_src

** Python debugger
#+begin_src bash :tangle no
# For Python debugging with dape
pip install debugpy
#+end_src

* Package Setup
#+begin_src emacs-lisp
;; Package setup
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(package-initialize)

;; Bootstrap use-package
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

;; Load use-package
(require 'use-package)
(setq use-package-always-ensure t)

;; Suppress additional byte-compilation warnings
(setq byte-compile-warnings '(not obsolete cl-functions))
#+end_src

* UI Settings
#+begin_src emacs-lisp
;; Remove window decorations
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)

;; Remove startup screen
(setq inhibit-startup-screen t)

;; Load theme
(load-file (expand-file-name "config/theme.el" user-emacs-directory))

;; Set font
(set-face-attribute 'default nil :font "CaskaydiaMono Nerd Font" :height 150)
#+end_src

* Editor Settings
#+begin_src emacs-lisp
;; Relative line numbers for text files
(add-hook 'text-mode-hook 'display-line-numbers-mode)
(add-hook 'prog-mode-hook 'display-line-numbers-mode)
(setq display-line-numbers-type 'relative)

;; Delete selection mode
(delete-selection-mode 1)

;; Show matching parentheses
(show-paren-mode 1)

;; Highlight current line
(global-hl-line-mode 1)

;; Change where file backups are created (file~)
(setq backup-directory-alist '(("." . "~/.emacs.d/backups")))

;; Change where auto-save files are created (#file#)
(setq auto-save-file-name-transforms
      '((".*" "~/.emacs.d/auto-saves/" t)))

;; Create auto-saves directory if it doesn't exist
(make-directory "~/.emacs.d/auto-saves/" t)

;; Disable lock files (.#file)
(setq create-lockfiles nil)

;; Recent file setting 
(recentf-mode 1)
(setq recentf-max-saved-items 100)
#+end_src

* Evil Mode Setup (Must be early)
#+begin_src emacs-lisp
;; Setup undo-tree BEFORE evil-mode
(use-package undo-tree
  :config
  (global-undo-tree-mode)
  ;; Undo-tree history files
  (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo-tree")))
  (make-directory "~/.emacs.d/undo-tree/" t)
  ;; Tell evil to use undo-tree
  (setq evil-undo-system 'undo-tree))

;; Evil collection must be set up BEFORE evil-mode is enabled
(setq evil-want-integration t)
(setq evil-want-keybinding nil)

;; Evil mode
(use-package evil
  :init
  (setq evil-want-C-u-scroll t)  ; Use C-u for scrolling
  :config
  (evil-mode 1))

;; Evil collection for better vim bindings everywhere
(use-package evil-collection
  :after evil
  :config
  (evil-collection-init))
#+end_src

* Completion Framework
** Vertico - Vertical completion UI
#+begin_src emacs-lisp
(use-package vertico
  :init
  (vertico-mode)
  :config
  ;; Cycle back to top/bottom
  (setq vertico-cycle t)
  ;; Show more candidates
  (setq vertico-count 20)
  
  ;; Enable vertico-directory for better path navigation
  (when (fboundp 'vertico-directory-mode)
    (vertico-directory-mode 1)))

;; Persist history over Emacs restarts
(use-package savehist
  :init
  (savehist-mode))

;; Disable icomplete-mode (conflicts with vertico)
(icomplete-mode -1)
#+end_src

** Orderless - Flexible completion style
#+begin_src emacs-lisp
(use-package orderless
  :custom
  ;; Use orderless for most completions, with basic as fallback
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  ;; File completion uses orderless + partial-completion for path expansion
  (completion-category-overrides '((file (styles orderless basic partial-completion))
                                   (buffer (styles orderless basic))
                                   (project-file (styles orderless basic))))
  ;; Case-insensitive completion
  :config
  (setq read-file-name-completion-ignore-case t
        read-buffer-completion-ignore-case t
        completion-ignore-case t))
#+end_src

** Marginalia - Annotations in completion
#+begin_src emacs-lisp
(use-package marginalia
  :init
  (marginalia-mode)
  :config
  (define-key minibuffer-local-map (kbd "M-A") 'marginalia-cycle))
#+end_src

** Embark - Context actions
#+begin_src emacs-lisp
(use-package embark
  :bind
  (("C-." . embark-act)         ; Pick an action
   ("M-." . embark-dwim)        ; Do what I mean
   ("C-h B" . embark-bindings)) ; Show all bindings
  :config
  ;; Show embark actions in a helpful buffer
  (setq prefix-help-command #'embark-prefix-help-command))

(use-package embark-consult
  :after (embark consult)
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** Consult - Enhanced search/navigation
#+begin_src emacs-lisp
(use-package consult
  :bind (;; C-x bindings (ctl-x-map)
         ("C-x b" . consult-buffer)
         ("C-x 4 b" . consult-buffer-other-window)
         ("C-x 5 b" . consult-buffer-other-frame)
         ("C-x r b" . consult-bookmark)
         ("C-x r x" . consult-register)
         ;; M-s bindings (search-map)
         ("M-s s" . consult-find)
         ("M-s /" . consult-ripgrep)
         ("M-s b" . consult-buffer)
         ("M-s r" . consult-recent-file)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ;; Isearch integration
         ("C-s" . consult-line)
         ("C-S-s" . consult-line-multi)
         ;; Other
         ("M-y" . consult-yank-pop)
         ("C-h i" . consult-info)
         ("C-c m" . consult-mode-command)
         ("C-c k" . consult-keep-lines))
  :config
  ;; Configure consult-find to show hidden files
  (setq consult-find-args "find . -not ( -path '*/.git/*' -prune )")
  
  ;; Configure consult-ripgrep to search hidden files
  (setq consult-ripgrep-args
        "rg --null --line-buffered --color=never --max-columns=1000 \
--path-separator / --smart-case --no-heading --with-filename \
--line-number --search-zip --hidden --glob=!.git/")
  
  ;; Preview settings
  (setq consult-preview-key 'any)
  (setq consult-narrow-key "<"))

;; Dired integration for consult keybindings
(defun my/dired-setup-consult-keys ()
  "Set up consult keybindings for dired mode."
  (define-key dired-mode-map (kbd "M-s s") 'consult-find)
  (define-key dired-mode-map (kbd "M-s /") 'consult-ripgrep)
  (define-key dired-mode-map (kbd "M-s b") 'consult-buffer)
  (define-key dired-mode-map (kbd "M-s r") 'consult-recent-file)
  
  ;; Also bind in evil states if evil is loaded
  (when (featurep 'evil)
    (dolist (state '(normal visual motion insert))
      (evil-define-key state dired-mode-map
        (kbd "M-s s") 'consult-find
        (kbd "M-s /") 'consult-ripgrep
        (kbd "M-s b") 'consult-buffer
        (kbd "M-s r") 'consult-recent-file))))

(with-eval-after-load 'dired
  (my/dired-setup-consult-keys)
  (add-hook 'dired-mode-hook #'my/dired-setup-consult-keys t))
#+end_src

** Corfu - In-buffer completion
#+begin_src emacs-lisp
(use-package corfu
  :custom
  ;; Enable auto-completion
  (corfu-auto t)
  (corfu-auto-delay 0.2)
  (corfu-auto-prefix 2)
  ;; Corfu behavior
  (corfu-cycle t)                ; Enable cycling
  (corfu-separator ?\s)          ; Use space as separator
  (corfu-quit-at-boundary t)     ; Quit at completion boundary
  (corfu-quit-no-match t)        ; Quit if no match
  (corfu-preview-current nil)    ; Don't preview current
  (corfu-preselect 'prompt)      ; Preselect prompt
  (corfu-scroll-margin 5)        ; Margin for scrolling
  :init
  (global-corfu-mode)
  :config
  ;; Keybindings for corfu-map
  (define-key corfu-map (kbd "TAB") 'corfu-next)
  (define-key corfu-map (kbd "<tab>") 'corfu-next)
  (define-key corfu-map (kbd "S-TAB") 'corfu-previous)
  (define-key corfu-map (kbd "<backtab>") 'corfu-previous)
  (define-key corfu-map (kbd "RET") 'corfu-insert)
  (define-key corfu-map (kbd "<return>") 'corfu-insert))

;; Corfu extensions
(use-package corfu-popupinfo
  :ensure nil  ; Built into corfu package
  :after corfu
  :hook (corfu-mode . corfu-popupinfo-mode)
  :custom
  (corfu-popupinfo-delay '(0.5 . 0.2)))
#+end_src

** Cape - Completion backends
#+begin_src emacs-lisp
(use-package cape
  :init
  ;; Add completion backends to completion-at-point-functions
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  :config
  ;; Silence the pcomplete capf, no errors or messages!
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-silent))
#+end_src

* Dired
#+begin_src emacs-lisp
;; Sort directories first (requires GNU ls)
(setq dired-listing-switches "-alh --group-directories-first")

;; Enable dired-dwim-target (copy/move between two dired buffers)
(setq dired-dwim-target t)

;; Auto-revert dired buffers
(setq dired-auto-revert-buffer t)

;; Hide dotfiles by default
(use-package dired-hide-dotfiles
  :hook (dired-mode . dired-hide-dotfiles-mode)
  :config
  (define-key dired-mode-map "." 'dired-hide-dotfiles-mode))
#+end_src

* Tree-sitter
#+begin_src emacs-lisp
;; Tree-sitter support (built-in for Emacs 29+)
(when (and (fboundp 'treesit-available-p)
           (treesit-available-p))
  
  ;; Set up tree-sitter grammar sources
  (setq treesit-language-source-alist
        '((bash "https://github.com/tree-sitter/tree-sitter-bash")
          (c "https://github.com/tree-sitter/tree-sitter-c")
          (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
          (css "https://github.com/tree-sitter/tree-sitter-css")
          (go "https://github.com/tree-sitter/tree-sitter-go")
          (html "https://github.com/tree-sitter/tree-sitter-html")
          (javascript "https://github.com/tree-sitter/tree-sitter-javascript")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (python "https://github.com/tree-sitter/tree-sitter-python")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
  
  ;; Auto-install grammars on first use
  (dolist (lang treesit-language-source-alist)
    (unless (treesit-language-available-p (car lang))
      (message "Installing tree-sitter grammar for %s..." (car lang))
      (treesit-install-language-grammar (car lang))))
  
  ;; treesit-auto: automatically use tree-sitter modes when available
  (use-package treesit-auto
    :demand t
    :config
    ;; Don't auto-install grammars (we already install them above)
    (setq treesit-auto-install 'prompt)
    ;; Enable globally
    (global-treesit-auto-mode)))
#+end_src

* Programming - LSP & Completion
** Eglot LSP
#+begin_src emacs-lisp
(use-package eglot
  :ensure nil  ; Built-in for Emacs 29+
  :hook (((python-mode python-ts-mode) . eglot-ensure)
         ((go-mode go-ts-mode) . eglot-ensure)
         ((c-mode c++-mode c-ts-mode c++-ts-mode) . eglot-ensure)
         ((js-mode js-ts-mode typescript-mode typescript-ts-mode tsx-ts-mode) . eglot-ensure)
         ((json-mode json-ts-mode) . eglot-ensure)
         (yaml-mode . eglot-ensure)
         (terraform-mode . eglot-ensure)
         (dockerfile-mode . eglot-ensure))
  :config
  ;; Keybindings (must be in :config since eglot-mode-map isn't defined until eglot loads)
  (define-key eglot-mode-map (kbd "C-c l a") 'eglot-code-actions)
  (define-key eglot-mode-map (kbd "C-c l r") 'eglot-rename)
  (define-key eglot-mode-map (kbd "C-c l f") 'eglot-format)
  (define-key eglot-mode-map (kbd "C-c l d") 'eglot-find-declaration)
  (define-key eglot-mode-map (kbd "C-c l i") 'eglot-find-implementation)
  (define-key eglot-mode-map (kbd "C-c l t") 'eglot-find-typeDefinition)
  (define-key eglot-mode-map (kbd "C-c l h") 'eldoc-doc-buffer)
  (define-key eglot-mode-map (kbd "C-c l s") 'eglot-reconnect)
  
  ;; Optimize performance
  (setq eglot-events-buffer-size 0)  ; Disable event logging
  (setq eglot-sync-connect nil)      ; Async connection
  
  ;; Configure TypeScript language server
  (add-to-list 'eglot-server-programs
               '((js-mode js-ts-mode typescript-mode typescript-ts-mode tsx-ts-mode)
                 . ("typescript-language-server" "--stdio"))))
#+end_src

** Language-specific modes
#+begin_src emacs-lisp
;; Go
(use-package go-mode
  :mode "\\.go\\'")

;; TypeScript/JavaScript
(use-package typescript-mode
  :mode (("\\.ts\\'" . typescript-mode)
         ("\\.tsx\\'" . tsx-ts-mode)))

;; JSON
(use-package json-mode
  :mode "\\.json\\'")

;; YAML
(use-package yaml-mode
  :mode "\\.ya?ml\\'")

;; Terraform
(use-package terraform-mode
  :mode "\\.tf\\'")

;; Dockerfile
(use-package dockerfile-mode
  :mode "Dockerfile\\'")

;; Kubernetes & Helm YAML files
(add-to-list 'auto-mode-alist '("\\.k8s\\.ya?ml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("k8s/.*\\.ya?ml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("Chart\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("values\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("templates/.*\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("templates/.*\\.tpl\\'" . yaml-mode))
#+end_src

* Debugging with Dape
#+begin_src emacs-lisp
(use-package dape
  :config
  ;; Save buffers on startup
  (add-hook 'dape-on-start-hooks (lambda () (save-some-buffers t t)))
  
  ;; Kill compile buffer on build success
  (add-hook 'dape-compile-compile-hook 'kill-buffer)
  
  ;; Use project root as working directory
  (setq dape-cwd-fn 'dape--default-cwd)
  
  ;; Global debugging keybindings
  :bind (("C-c d d" . dape)
         ("C-c d p" . dape-pause)
         ("C-c d c" . dape-continue)
         ("C-c d n" . dape-next)
         ("C-c d s" . dape-step-in)
         ("C-c d o" . dape-step-out)
         ("C-c d r" . dape-restart)
         ("C-c d k" . dape-kill)
         ("C-c d q" . dape-quit)
         ("C-c d b" . dape-breakpoint-toggle)
         ("C-c d l" . dape-breakpoint-log)
         ("C-c d e" . dape-breakpoint-expression)
         ("C-c d w" . dape-watch-dwim)
         ("C-c d i" . dape-info)
         ("C-c d R" . dape-repl)))

;; Dape configurations for different languages
(with-eval-after-load 'dape
  ;; Python (debugpy) - install with: pip install debugpy
  (add-to-list 'dape-configs
               `(debugpy
                 modes (python-mode python-ts-mode)
                 command "python"
                 command-args ("-m" "debugpy.adapter")
                 :request "launch"
                 :type "executable"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))
  
  ;; Go (delve) - install with: go install github.com/go-delve/delve/cmd/dlv@latest
  (add-to-list 'dape-configs
               `(delve
                 modes (go-mode go-ts-mode)
                 command "dlv"
                 command-args ("dap" "--listen" "127.0.0.1:55878")
                 command-cwd dape-cwd-fn
                 port 55878
                 :request "launch"
                 :type "debug"
                 :mode "debug"
                 :program dape-cwd-fn))
  
  ;; C/C++ (gdb)
  (add-to-list 'dape-configs
               `(gdb
                 modes (c-mode c++-mode c-ts-mode c++-ts-mode)
                 command "gdb"
                 command-args ("-i" "dap")
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "executable"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))
  
  ;; C/C++ (lldb) - alternative to gdb
  (add-to-list 'dape-configs
               `(lldb
                 modes (c-mode c++-mode c-ts-mode c++-ts-mode)
                 command "lldb-vscode"
                 command-args ()
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "lldb"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))
  
  ;; Node.js (for JavaScript/TypeScript debugging)
  (add-to-list 'dape-configs
               `(node
                 modes (js-mode js-ts-mode typescript-mode typescript-ts-mode)
                 command "node"
                 command-args ("--inspect-brk" dape-buffer-default)
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "node"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default)))
#+end_src

* Org Mode
#+begin_src emacs-lisp
;; Org mode basic settings
(setq org-startup-indented t)
(setq org-hide-leading-stars t)

;; Enable folding (TAB to toggle)
(setq org-startup-folded 'content)

;; Syntax highlighting in code blocks
(setq org-src-fontify-natively t)
(setq org-src-tab-acts-natively t)

;; Enable Babel for code execution
(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
   (python . t)
   (C . t)
   (shell . t)
   (js . t)))

;; Don't ask for confirmation before executing code blocks
(setq org-confirm-babel-evaluate nil)

;; Better code block editing
(setq org-edit-src-content-indentation 0)
(setq org-src-preserve-indentation t)
(setq org-src-window-setup 'current-window)

;; Enable eglot in org-src edit buffers
(defun my/org-babel-edit-prep (info)
  "Enable eglot in org src blocks by setting buffer-file-name."
  (setq buffer-file-name (or (alist-get :file (caddr info))
                             "org-src-babel-tmp"))
  (when (derived-mode-p 'prog-mode)
    (eglot-ensure)))

(advice-add 'org-edit-src-code
            :before
            (defun my/org-edit-src-code-advice (&rest args)
              (when-let* ((element (org-element-at-point))
                          (type (org-element-type element))
                          (lang (org-element-property :language element))
                          (mode (org-src-get-lang-mode lang))
                          ((eglot--lookup-mode mode))
                          (edit-prep (intern (format "org-babel-edit-prep:%s" lang))))
                (unless (fboundp edit-prep)
                  (fset edit-prep #'my/org-babel-edit-prep)))))

;; Keybindings for org-mode
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "C-c C-c") 'org-ctrl-c-ctrl-c)
  (define-key org-mode-map (kbd "C-c '") 'org-edit-special))

;; Org-modern for beautiful org-mode appearance
(use-package org-modern
  :hook ((org-mode . org-modern-mode)
         (org-agenda-finalize . org-modern-agenda))
  :custom
  ;; Modern styling
  (org-modern-star '("●" "○" "✸" "✿"))
  (org-modern-table nil)  ; Set to t if you want modern table styling
  (org-modern-hide-stars nil)  ; Show decorative stars
  (org-modern-block-fringe nil)
  
  ;; Checkbox styling
  (org-modern-checkbox
   '((?X . "☑")
     (?- . "⊟")
     (?\s . "☐")))
  
  ;; Tag styling
  (org-modern-tag t)
  (org-modern-priority t)
  
  ;; Keyword styling
  (org-modern-keyword t)
  (org-modern-timestamp t)
  (org-modern-statistics t)
  
  ;; Block styling
  (org-modern-block-name t)
  
  ;; List styling  
  (org-modern-list
   '((?+ . "◦")
     (?- . "–")
     (?* . "•"))))

;; Additional visual improvements for org-mode
(with-eval-after-load 'org
  ;; Better heading sizes
  (custom-set-faces
   '(org-level-1 ((t (:height 1.3 :weight bold))))
   '(org-level-2 ((t (:height 1.2 :weight semi-bold))))
   '(org-level-3 ((t (:height 1.1 :weight semi-bold))))
   '(org-document-title ((t (:height 1.5 :weight bold)))))
  
  ;; Better spacing
  (setq org-cycle-separator-lines 2))
#+end_src

* Terminal
#+begin_src emacs-lisp
;; Vterm - best terminal emulator for Emacs
;; Vterm - best terminal emulator for Emacs
(use-package vterm
  :config
  (setq vterm-always-compile-module t)
  (setq vterm-max-scrollback 10000)
  
  ;; Disable Evil mode in vterm
  (evil-set-initial-state 'vterm-mode 'emacs)
  
  ;; Fix colors - use faces that match your theme
  (setq vterm-term-environment-variable "xterm-256color")
  
  ;; Set vterm colors to match your Menudo theme
  (defun my/vterm-setup-colors ()
    "Set vterm colors to match Menudo theme."
    (setq vterm-color-black "#000000"
          vterm-color-red "#dc322f"
          vterm-color-green "#66bc11"
          vterm-color-yellow "#b58900"
          vterm-color-blue "#268bd2"
          vterm-color-magenta "#af87d7"
          vterm-color-cyan "#5fafaf"
          vterm-color-white "#cccccc"
          ;; Bright colors
          vterm-color-bright-black "#666666"
          vterm-color-bright-red "#dc7575"
          vterm-color-bright-green "#66bc11"
          vterm-color-bright-yellow "#f0bb0c"
          vterm-color-bright-blue "#268bd2"
          vterm-color-bright-magenta "#af87d7"
          vterm-color-bright-cyan "#5fafaf"
          vterm-color-bright-white "#cccccc"))
  
  (add-hook 'vterm-mode-hook #'my/vterm-setup-colors))
  #+end_src
  
* Visual Enhancements
#+begin_src emacs-lisp
;; Rainbow delimiters - colorful parentheses
(use-package rainbow-delimiters
  :hook ((prog-mode . rainbow-delimiters-mode)
         (emacs-lisp-mode . rainbow-delimiters-mode)
         (lisp-mode . rainbow-delimiters-mode)
         (scheme-mode . rainbow-delimiters-mode)))
#+end_src

* Version Control
#+begin_src emacs-lisp
;; Magit - best Git interface
(use-package magit
  :bind ("C-x g" . magit-status)
  :config
  ;; Show word-granularity diff
  (setq magit-diff-refine-hunk 'all))

;; Diff-hl - show git changes in gutter
(use-package diff-hl
  :hook ((prog-mode . diff-hl-mode)
         (org-mode . diff-hl-mode)
         (dired-mode . diff-hl-dired-mode)
         (magit-post-refresh . diff-hl-magit-post-refresh)))
#+end_src

* Custom Navigation Functions
#+begin_src emacs-lisp
;;==============================================================================
;; DIRECTORY CANDIDATES HELPER
;;==============================================================================
(defvar my/directory-history nil
  "History for directory selection.")

(defvar my/base-directories '("~/projects" "~/.config" "~")
  "Base directories to scan for projects.")

(defun my/get-directory-candidates ()
  "Get list of directories from common project locations."
  (let ((dirs '()))
    (dolist (base-dir my/base-directories)
      (let ((expanded (expand-file-name base-dir)))
        (when (file-directory-p expanded)
          ;; Add the base directory
          (push expanded dirs)
          ;; Add subdirectories
          (when-let ((subdirs (directory-files expanded t directory-files-no-dot-files-regexp t)))
            (dolist (subdir subdirs)
              (when (file-directory-p subdir)
                (push subdir dirs)))))))
    (nreverse dirs)))

;;==============================================================================
;; CONSULT-BASED NAVIGATION FUNCTIONS
;;==============================================================================
(defun my/consult-sessionizer ()
  "Consult-based directory selection. Opens selected directory in dired."
  (interactive)
  (require 'consult)
  (let ((candidates (my/get-directory-candidates)))
    (if candidates
        (when-let ((selected (consult--read candidates
                                            :prompt "Select directory: "
                                            :require-match t
                                            :sort nil
                                            :category 'file
                                            :history 'my/directory-history)))
          (dired selected)
          (message "Opened: %s" selected))
      (dired default-directory)
      (message "No project directories found. Opened current directory."))))

(defun my/consult-project-dirs ()
  "Consult-based directory selection from common project directories."
  (interactive)
  (require 'consult)
  (when-let* ((candidates (my/get-directory-candidates))
              (selected (consult--read candidates
                                      :prompt "Select directory: "
                                      :require-match t
                                      :sort nil
                                      :category 'file
                                      :history 'my/directory-history)))
    (dired selected)))

;;==============================================================================
;; PROJECT CREATION
;;==============================================================================
(defun my/git-init-and-commit (project-dir project-name)
  "Initialize git repo and create initial commit in PROJECT-DIR for PROJECT-NAME."
  (let ((default-directory project-dir))
    (unless (zerop (call-process "git" nil nil nil "init" "-b" "main"))
      (error "Failed to initialize git repository"))
    
    ;; Create README.md
    (with-temp-file (expand-file-name "README.md" project-dir)
      (insert (format "# %s\n\nProject description\n" project-name)))
    
    ;; Initial commit
    (unless (zerop (call-process "git" nil nil nil "add" "README.md"))
      (error "Failed to stage README.md"))
    (unless (zerop (call-process "git" nil nil nil "commit" "-m" "initial commit"))
      (error "Failed to create initial commit"))
    (message "Git repository initialized with initial commit")))

(defun my/create-github-repo (project-name visibility)
  "Create GitHub repository for PROJECT-NAME with VISIBILITY."
  (let ((command (format "gh repo create %s %s --source=. --remote=origin --push" 
                         project-name visibility)))
    (message "Creating GitHub repository...")
    (if (zerop (call-process-shell-command command))
        (progn
          (message "GitHub repository created: %s" project-name)
          (sleep-for 1))
      (message "Warning: GitHub repository creation may have failed"))))

(defun my/create-new-project ()
  "Create new project directory with git and optional GitHub setup."
  (interactive)
  (let* ((project-name (string-trim (read-string "Project name: ")))
         (project-dir (expand-file-name project-name "~/projects"))
         (gh-available (executable-find "gh"))
         (create-github (and gh-available (y-or-n-p "Create GitHub repository? ")))
         (visibility (when create-github
                       (if (y-or-n-p "Public repository? ")
                           "--public"
                         "--private"))))
    
    ;; Validate
    (when (string-empty-p project-name)
      (user-error "Project name cannot be empty"))
    
    (when (file-exists-p project-dir)
      (unless (y-or-n-p (format "Directory %s exists. Use it? " project-dir))
        (user-error "Project directory already exists")))
    
    ;; Create project
    (make-directory project-dir t)
    (message "Created: %s" project-dir)
    
    ;; Initialize git if needed
    (unless (file-exists-p (expand-file-name ".git" project-dir))
      (my/git-init-and-commit project-dir project-name)
      
      ;; Create GitHub repo if requested
      (when create-github
        (my/create-github-repo project-name visibility)))
    
    ;; Open in dired
    (dired project-dir)))

;;==============================================================================
;; GITHUB PR HELPER
;;==============================================================================
(defun my/get-git-info ()
  "Get git remote URL and current branch."
  (let ((default-directory (or default-directory
                               (and buffer-file-name 
                                    (file-name-directory buffer-file-name))
                               "~/")))
    (when (locate-dominating-file default-directory ".git")
      (let ((remote (string-trim (shell-command-to-string "git config --get remote.origin.url")))
            (branch (string-trim (shell-command-to-string "git rev-parse --abbrev-ref HEAD"))))
        (when (and (not (string-empty-p remote))
                   (not (string-empty-p branch)))
          (cons remote branch))))))

(defun my/convert-to-github-url (remote-url)
  "Convert git REMOTE-URL to GitHub HTTPS URL."
  (cond
   ((string-match "^git@github\\.com:\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   ((string-match "^https://github\\.com/\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   ((not (string-match-p "github\\.com" remote-url))
    (error "Not a GitHub repository: %s" remote-url))
   (t remote-url)))

(defun my/open-github-pr ()
  "Open GitHub compare page for current branch in browser."
  (interactive)
  (if-let* ((git-info (my/get-git-info))
            (remote-url (car git-info))
            (branch (cdr git-info))
            (github-url (my/convert-to-github-url remote-url))
            (compare-url (concat github-url "/compare/" branch)))
      (progn
        (browse-url compare-url)
        (message "Opening: %s" compare-url))
    (user-error "Not in a git repository or missing remote/branch")))

;;==============================================================================
;; KEYBINDINGS
;;==============================================================================
;; Global keybindings (work in Emacs state and when Evil is not loaded)
(global-set-key (kbd "C-c p s") 'my/consult-sessionizer)
(global-set-key (kbd "C-c p n") 'my/create-new-project)
(global-set-key (kbd "C-c p r") 'my/open-github-pr)

;; Evil mode keybindings (must be defined in Evil states)
(with-eval-after-load 'evil
  ;; Define in all evil states so they work everywhere
  (dolist (state '(normal insert visual motion emacs))
    (evil-define-key state 'global (kbd "C-S-f") 'my/consult-sessionizer)
    (evil-define-key state 'global (kbd "C-S-n") 'my/create-new-project)
    (evil-define-key state 'global (kbd "C-S-p") 'my/open-github-pr))
  
  ;; SPC leader keybindings (normal mode only)
  (evil-define-key 'normal 'global (kbd "SPC p s") 'my/consult-sessionizer)
  (evil-define-key 'normal 'global (kbd "SPC p n") 'my/create-new-project)
  (evil-define-key 'normal 'global (kbd "SPC p r") 'my/open-github-pr))
#+end_src

* Performance Optimizations
#+begin_src emacs-lisp
;; Note: GC threshold is set in early-init.el and reset after startup
;; These are additional runtime optimizations

;; Increase amount of data read from processes (important for LSP)
(setq read-process-output-max (* 1024 1024))  ; 1MB

;; Reduce rendering overhead
(setq redisplay-skip-fontification-on-input t)

;; Reduce frequency of garbage collection by making it happen on idle
(run-with-idle-timer 5 t #'garbage-collect)
#+end_src
