#+TITLE: PrawnFarmerDev Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/init.el

* System Requirements
Before using this configuration, install the following packages on your Arch system:

** Core tools
#+begin_src bash :tangle no
# Package manager and Git
sudo pacman -S git ripgrep

# Language servers
sudo pacman -S python-lsp-server gopls clang typescript-language-server

# Tree-sitter grammars (optional, will auto-install from Emacs)
# If on Emacs 29+, tree-sitter support is built-in
#+end_src

** AUR packages (using yay or paru)
#+begin_src bash :tangle no
# JSON language server
yay -S vscode-json-languageserver

# YAML language server
yay -S yaml-language-server-bin

# Terraform language server
yay -S terraform-ls

# Dockerfile language server
yay -S dockerfile-language-server-bin

# GitHub CLI (optional, for project creation)
yay -S github-cli
#+end_src

** Alternative installation via npm
#+begin_src bash :tangle no
# If you prefer npm installation:
npm install -g vscode-langservers-extracted  # includes json-languageserver
npm install -g yaml-language-server
npm install -g @ansible/ansible-language-server  # if you use Ansible
#+end_src

* Package Setup
#+begin_src emacs-lisp
;; Package setup
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(package-initialize)

;; Install packages if not already installed
(dolist (package '(evil evil-collection consult vterm magit company undo-tree go-mode use-package
                   yaml-mode json-mode terraform-mode dockerfile-mode typescript-mode))
  (unless (package-installed-p package)
    (package-refresh-contents)
    (package-install package)))

;; Enable use-package
(eval-when-compile
  (require 'use-package))
#+end_src

* UI Settings
#+begin_src emacs-lisp
;; Remove window decorations
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)

;; Remove startup screen
(setq inhibit-startup-screen t)

;; Load theme
(load-file (expand-file-name "config/theme.el" user-emacs-directory))

;; Set font
(set-face-attribute 'default nil :font "CaskaydiaMono Nerd Font" :height 150)
#+end_src

* Editor Settings
#+begin_src emacs-lisp
;; Relative line numbers for text files
(add-hook 'text-mode-hook 'display-line-numbers-mode)
(add-hook 'prog-mode-hook 'display-line-numbers-mode)
(setq display-line-numbers-type 'relative)

;; Delete selection mode
(delete-selection-mode 1)

;; Show matching parentheses
(show-paren-mode 1)

;; Highlight current line
(global-hl-line-mode 1)

;; Change where file backups are created (file~)
(setq backup-directory-alist '(("." . "~/.emacs.d/backups")))

;; Change where auto-save files are created (#file#)
(setq auto-save-file-name-transforms
      '((".*" "~/.emacs.d/auto-saves/" t)))

;; Create auto-saves directory if it doesn't exist
(make-directory "~/.emacs.d/auto-saves/" t)

;; Disable lock files (.#file)
(setq create-lockfiles nil)

;; Undo-tree history files
(setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo-tree")))
(make-directory "~/.emacs.d/undo-tree/" t)
#+end_src

* Completion
#+begin_src emacs-lisp
;; Set mini-buffer completion mode
(fido-vertical-mode)

;; Consult for enhanced search commands
(require 'consult)

;; Configure consult-find to show hidden files
(setq consult-find-args "find . -not ( -path '*/.git/*' -prune )")

;; Configure consult-ripgrep to search hidden files
(setq consult-ripgrep-args "rg --null --line-buffered --color=never --max-columns=1000 --path-separator / --smart-case --no-heading --with-filename --line-number --search-zip --hidden --glob=!.git/")

;; Keybindings for Telescope-like fuzzy finding (Alt-s prefix)
(global-set-key (kbd "M-s f") 'consult-find)        ; Find files
(global-set-key (kbd "M-s g") 'consult-ripgrep)     ; Ripgrep search
(global-set-key (kbd "M-s b") 'consult-buffer)      ; Switch buffers
(global-set-key (kbd "M-s l") 'consult-line)        ; Search in current buffer

;; Make consult searches work in dired with M‑S‑s prefix (Shift+Alt+s)
(defun my/dired-setup-shift-consult-keys ()
  "Set up consult keybindings for dired mode using M‑S‑s prefix.
Binds M‑S‑s f/g/b/l to consult commands, preserving dired’s M‑s sorting keys."
  ;; Set bindings in dired‑mode‑map for non‑evil usage
  (define-key dired-mode-map (kbd "M-S-s f") 'consult-find)
  (define-key dired-mode-map (kbd "M-S-s g") 'consult-ripgrep)
  (define-key dired-mode-map (kbd "M-S-s b") 'consult-buffer)
  (define-key dired-mode-map (kbd "M-S-s l") 'consult-line)
  
  ;; Also bind in evil states (for evil‑collection users)
  (when (featurep 'evil)
    (dolist (state '(normal visual motion insert))
      (evil-define-key state dired-mode-map
        (kbd "M-S-s f") 'consult-find
        (kbd "M-S-s g") 'consult-ripgrep
        (kbd "M-S-s b") 'consult-buffer
        (kbd "M-S-s l") 'consult-line))))

;; Apply keybindings when dired loads
(with-eval-after-load 'dired
  (my/dired-setup-shift-consult-keys)
  
  ;; Re‑apply after evil‑collection loads (if it overrides bindings)
  (with-eval-after-load 'evil-collection
    (my/dired-setup-shift-consult-keys))
  
  ;; Final safety: apply to each dired buffer
  (add-hook 'dired-mode-hook #'my/dired-setup-shift-consult-keys t)
  
  (message "Shift consult keybindings configured for dired"))
#+end_src

* Dired
#+begin_src emacs-lisp
;; Sort directories first (requires GNU ls)
(setq dired-listing-switches "-alh --group-directories-first")

;; Enable dired-dwim-target (copy/move between two dired buffers)
(setq dired-dwim-target t)
#+end_src

* Tree-sitter
#+begin_src emacs-lisp
;; Tree-sitter support (built-in for Emacs 29+)
(when (and (fboundp 'treesit-available-p)
           (treesit-available-p))
  
  ;; Set up tree-sitter grammar sources
  (setq treesit-language-source-alist
        '((bash "https://github.com/tree-sitter/tree-sitter-bash")
          (c "https://github.com/tree-sitter/tree-sitter-c")
          (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
          (css "https://github.com/tree-sitter/tree-sitter-css")
          (go "https://github.com/tree-sitter/tree-sitter-go")
          (html "https://github.com/tree-sitter/tree-sitter-html")
          (javascript "https://github.com/tree-sitter/tree-sitter-javascript")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (python "https://github.com/tree-sitter/tree-sitter-python")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
  
  ;; Auto-install grammars on first use
  (dolist (lang treesit-language-source-alist)
    (unless (treesit-language-available-p (car lang))
      (message "Installing tree-sitter grammar for %s..." (car lang))
      (treesit-install-language-grammar (car lang))))
  
  ;; Use tree-sitter modes when available
  (setq major-mode-remap-alist
        '((python-mode . python-ts-mode)
          (javascript-mode . js-ts-mode)
          (js-json-mode . json-ts-mode)
          (css-mode . css-ts-mode)
          (bash-mode . bash-ts-mode)
          (c-mode . c-ts-mode)
          (c++-mode . c++-ts-mode)
          (go-mode . go-ts-mode)))
  
  (message "Tree-sitter enabled"))
#+end_src

* Programming
#+begin_src emacs-lisp
;; Company mode for completion
(require 'company)
(add-hook 'after-init-hook 'global-company-mode)
(setq company-idle-delay 0.1)
(setq company-minimum-prefix-length 1)

;; Eglot LSP setup
(require 'eglot)

;; Eglot keybindings
(with-eval-after-load 'eglot
  (define-key eglot-mode-map (kbd "C-c l a") 'eglot-code-actions)
  (define-key eglot-mode-map (kbd "C-c l r") 'eglot-rename)
  (define-key eglot-mode-map (kbd "C-c l f") 'eglot-format)
  (define-key eglot-mode-map (kbd "C-c l d") 'eglot-find-declaration)
  (define-key eglot-mode-map (kbd "C-c l i") 'eglot-find-implementation)
  (define-key eglot-mode-map (kbd "C-c l t") 'eglot-find-typeDefinition)
  (define-key eglot-mode-map (kbd "C-c l h") 'eldoc-doc-buffer)
  (define-key eglot-mode-map (kbd "C-c l s") 'eglot-reconnect))

;; Python - requires pyright or pylsp
;; Install: sudo pacman -S python-lsp-server
(add-hook 'python-mode-hook 'eglot-ensure)
(add-hook 'python-ts-mode-hook 'eglot-ensure)

;; Go - requires gopls
;; Install: sudo pacman -S gopls
(use-package go-mode
  :ensure t
  :mode "\\.go\\'"
  :hook (go-mode . eglot-ensure))
(add-hook 'go-ts-mode-hook 'eglot-ensure)

;; C/C++ - requires clangd
;; Install: sudo pacman -S clang
(add-hook 'c-mode-hook 'eglot-ensure)
(add-hook 'c++-mode-hook 'eglot-ensure)
(add-hook 'c-ts-mode-hook 'eglot-ensure)
(add-hook 'c++-ts-mode-hook 'eglot-ensure)

;; JavaScript/TypeScript - requires typescript-language-server
;; Install: sudo pacman -S typescript-language-server
(use-package typescript-mode
  :ensure t
  :mode (("\\.ts\\'" . typescript-mode)
         ("\\.tsx\\'" . tsx-ts-mode))
  :hook ((typescript-mode . eglot-ensure)
         (tsx-ts-mode . eglot-ensure)))

(add-hook 'js-mode-hook 'eglot-ensure)
(add-hook 'js-ts-mode-hook 'eglot-ensure)
(add-hook 'typescript-ts-mode-hook 'eglot-ensure)

;; Configure eglot for JavaScript/TypeScript
(with-eval-after-load 'eglot
  (add-to-list 'eglot-server-programs
               '((js-mode js-ts-mode typescript-mode typescript-ts-mode tsx-ts-mode)
                 . ("typescript-language-server" "--stdio"))))

;; JSON - requires vscode-json-languageserver
;; Install: yay -S vscode-json-languageserver
(use-package json-mode
  :ensure t
  :mode "\\.json\\'"
  :hook (json-mode . eglot-ensure))
(add-hook 'json-ts-mode-hook 'eglot-ensure)

;; YAML - requires yaml-language-server
;; Install: yay -S yaml-language-server-bin
(use-package yaml-mode
  :ensure t
  :mode ("\\.ya?ml\\'" . yaml-mode)
  :hook (yaml-mode . eglot-ensure))

;; Terraform - requires terraform-ls
;; Install: yay -S terraform-ls
(use-package terraform-mode
  :ensure t
  :mode "\\.tf\\'"
  :hook (terraform-mode . eglot-ensure))

;; Dockerfile - requires dockerfile-language-server
;; Install: yay -S dockerfile-language-server-bin
(use-package dockerfile-mode
  :ensure t
  :mode "Dockerfile\\'"
  :hook (dockerfile-mode . eglot-ensure))

;; Kubernetes YAML files (use yaml-mode with k8s detection)
(add-to-list 'auto-mode-alist '("\\.k8s\\.ya?ml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("k8s/.*\\.ya?ml\\'" . yaml-mode))

;; Helm charts (also yaml)
(add-to-list 'auto-mode-alist '("Chart\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("values\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("templates/.*\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("templates/.*\\.tpl\\'" . yaml-mode))

;; Format on save (optional)
;; (add-hook 'before-save-hook 'eglot-format-buffer)
#+end_src

* Org Mode
#+begin_src emacs-lisp
;; Org mode basic settings
(setq org-startup-indented t)
(setq org-hide-leading-stars t)

;; Enable folding (TAB to toggle)
(setq org-startup-folded 'content)

;; Syntax highlighting in code blocks
(setq org-src-fontify-natively t)
(setq org-src-tab-acts-natively t)

;; Enable Babel for code execution (REPL-like)
(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
   (python . t)
   (C . t)
   (shell . t)
   (js . t)))

;; Don't ask for confirmation before executing code blocks
(setq org-confirm-babel-evaluate nil)

;; Better code block editing
(setq org-edit-src-content-indentation 0)
(setq org-src-preserve-indentation t)

;; Make org-src windows use the same window (easier for LSP)
(setq org-src-window-setup 'current-window)

;; Enable eglot in org-src edit buffers (C-c ')
(require 'eglot)
(defun my/org-babel-edit-prep (info)
  "Enable eglot in org src blocks by setting buffer-file-name."
  (setq buffer-file-name (or (alist-get :file (caddr info))
                             "org-src-babel-tmp"))
  (eglot-ensure))

(advice-add 'org-edit-src-code
            :before (defun my/org-edit-src-code-advice (&rest args)
                      (when-let* ((element (org-element-at-point))
                                  (type (org-element-type element))
                                  (lang (org-element-property :language element))
                                  (mode (org-src-get-lang-mode lang))
                                  ((eglot--lookup-mode mode))
                                  (edit-prep (intern
                                              (format "org-babel-edit-prep:%s" lang))))
                        (if (fboundp edit-prep)
                            (advice-add edit-prep :after #'my/org-babel-edit-prep)
                          (fset edit-prep #'my/org-babel-edit-prep)))))

;; Keybindings for org-mode
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "C-c C-c") 'org-ctrl-c-ctrl-c)  ; Execute code block
  (define-key org-mode-map (kbd "C-c '") 'org-edit-special))    ; Edit code block in separate buffer
#+end_src
* Terminal
#+begin_src emacs-lisp
;; Eshell is built-in, no setup needed

;; Vterm
(setq vterm-always-compile-module t)
(require 'vterm)
#+end_src

* Version Control
#+begin_src emacs-lisp
;; Magit
(require 'magit)
(global-set-key (kbd "C-x g") 'magit-status)
#+end_src

* Custom Navigation Functions
#+begin_src emacs-lisp
;;==============================================================================
;; DIRECTORY CANDIDATES HELPER
;;==============================================================================
(defvar my/directory-history nil
  "History for directory selection.")

(defvar my/base-directories '("~/projects" "~/.config" "~")
  "Base directories to scan for projects.")

(defun my/get-directory-candidates ()
  "Get list of directories from common project locations.
Caches results and filters out non-existent directories efficiently."
  (let ((dirs '()))
    (dolist (base-dir my/base-directories)
      (let ((expanded (expand-file-name base-dir)))
        (when (file-directory-p expanded)
          ;; Add the base directory
          (push expanded dirs)
          ;; Add subdirectories in one pass
          (when-let ((subdirs (directory-files expanded t directory-files-no-dot-files-regexp t)))
            (dolist (subdir subdirs)
              (when (file-directory-p subdir)
                (push subdir dirs)))))))
    (nreverse dirs)))

;;==============================================================================
;; CONSULT-BASED NAVIGATION FUNCTIONS
;;==============================================================================
;;;###autoload
(defun my/consult-sessionizer ()
  "Consult-based directory selection. Opens selected directory in dired."
  (interactive)
  (let ((candidates (my/get-directory-candidates)))
    (if candidates
        (when-let ((selected (consult--read candidates
                                            :prompt "Select directory: "
                                            :require-match t
                                            :sort nil
                                            :category 'file
                                            :history 'my/directory-history)))
          (dired selected)
          (message "Opened: %s" selected))
      (dired default-directory)
      (message "No project directories found. Opened current directory."))))

;;;###autoload
(defun my/consult-project-dirs ()
  "Consult-based directory selection from common project directories."
  (interactive)
  (when-let* ((candidates (my/get-directory-candidates))
              (selected (consult--read candidates
                                      :prompt "Select directory: "
                                      :require-match t
                                      :sort nil
                                      :category 'file
                                      :history 'my/directory-history)))
    (dired selected)))

;;==============================================================================
;; PROJECT CREATION
;;==============================================================================
(defun my/git-init-and-commit (project-dir project-name)
  "Initialize git repo and create initial commit in PROJECT-DIR for PROJECT-NAME."
  (let ((default-directory project-dir))
    (unless (zerop (call-process "git" nil nil nil "init" "-b" "main"))
      (error "Failed to initialize git repository"))
    
    ;; Create README.md
    (with-temp-file (expand-file-name "README.md" project-dir)
      (insert (format "# %s\n\nProject description\n" project-name)))
    
    ;; Initial commit
    (unless (zerop (call-process "git" nil nil nil "add" "README.md"))
      (error "Failed to stage README.md"))
    (unless (zerop (call-process "git" nil nil nil "commit" "-m" "initial commit"))
      (error "Failed to create initial commit"))
    (message "Git repository initialized with initial commit")))

(defun my/create-github-repo (project-name visibility)
  "Create GitHub repository for PROJECT-NAME with VISIBILITY."
  (let ((command (format "gh repo create %s %s --source=. --remote=origin --push" 
                         project-name visibility)))
    (message "Creating GitHub repository...")
    (if (zerop (call-process-shell-command command))
        (progn
          (message "GitHub repository created: %s" project-name)
          (sleep-for 1))
      (message "Warning: GitHub repository creation may have failed"))))

;;;###autoload
(defun my/create-new-project ()
  "Create new project directory with git and optional GitHub setup.
Prompts for project name, creates directory in ~/projects/, initializes git,
and optionally creates GitHub repository using gh CLI."
  (interactive)
  (let* ((project-name (string-trim (read-string "Project name: ")))
         (project-dir (expand-file-name project-name "~/projects"))
         (gh-available (executable-find "gh"))
         (create-github (and gh-available (y-or-n-p "Create GitHub repository? ")))
         (visibility (when create-github
                       (if (y-or-n-p "Public repository? ")
                           "--public"
                         "--private"))))
    
    ;; Validate
    (when (string-empty-p project-name)
      (user-error "Project name cannot be empty"))
    
    (when (file-exists-p project-dir)
      (unless (y-or-n-p (format "Directory %s exists. Use it? " project-dir))
        (user-error "Project directory already exists")))
    
    ;; Create project
    (make-directory project-dir t)
    (message "Created: %s" project-dir)
    
    ;; Initialize git if needed
    (unless (file-exists-p (expand-file-name ".git" project-dir))
      (my/git-init-and-commit project-dir project-name)
      
      ;; Create GitHub repo if requested
      (when create-github
        (my/create-github-repo project-name visibility)))
    
    ;; Open in dired
    (dired project-dir)))

;;==============================================================================
;; GITHUB PR HELPER
;;==============================================================================
(defun my/get-git-info ()
  "Get git remote URL and current branch. Returns (remote-url . branch) or nil."
  (let ((default-directory (or default-directory
                               (and buffer-file-name 
                                    (file-name-directory buffer-file-name))
                               "~/")))
    (when (locate-dominating-file default-directory ".git")
      (let ((remote (string-trim (shell-command-to-string "git config --get remote.origin.url")))
            (branch (string-trim (shell-command-to-string "git rev-parse --abbrev-ref HEAD"))))
        (when (and (not (string-empty-p remote))
                   (not (string-empty-p branch)))
          (cons remote branch))))))

(defun my/convert-to-github-url (remote-url)
  "Convert git REMOTE-URL to GitHub HTTPS URL."
  (cond
   ;; SSH format: git@github.com:user/repo.git or git@github.com:user/repo
   ((string-match "^git@github\\.com:\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   ;; HTTPS format: https://github.com/user/repo.git
   ((string-match "^https://github\\.com/\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   ;; Not a GitHub URL
   ((not (string-match-p "github\\.com" remote-url))
    (error "Not a GitHub repository: %s" remote-url))
   (t remote-url)))

;;;###autoload
(defun my/open-github-pr ()
  "Open GitHub compare page for current branch in browser."
  (interactive)
  (if-let* ((git-info (my/get-git-info))
            (remote-url (car git-info))
            (branch (cdr git-info))
            (github-url (my/convert-to-github-url remote-url))
            (compare-url (concat github-url "/compare/" branch)))
      (progn
        (browse-url compare-url)
        (message "Opening: %s" compare-url))
    (user-error "Not in a git repository or missing remote/branch")))

;;==============================================================================
;; KEYBINDINGS
;;==============================================================================
(global-set-key (kbd "C-S-f") 'my/consult-sessionizer)
(global-set-key (kbd "C-S-n") 'my/create-new-project)
(global-set-key (kbd "C-S-p") 'my/open-github-pr)
#+end_src

* Evil Mode
#+begin_src emacs-lisp
;; Setup undo-tree BEFORE evil-mode
(require 'undo-tree)
(global-undo-tree-mode)

;; Tell evil to use undo-tree
(setq evil-undo-system 'undo-tree)

;; Evil collection must be set up before evil-mode is enabled
(setq evil-want-integration t)
(setq evil-want-keybinding nil)

;; Evil mode
(require 'evil)
(evil-mode 1)

;; Evil collection for better vim bindings everywhere
(require 'evil-collection)
(evil-collection-init)
#+end_src
