#+TITLE: PrawnFarmerDev Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/init.el

* Early Init (Performance & Warning Suppression)
This section creates an early-init.el file for startup optimizations and warning suppression.
#+begin_src emacs-lisp :tangle ~/.emacs.d/early-init.el
;; early-init.el --- Early initialization -*- lexical-binding: t -*-

;; Increase GC threshold during startup for faster loading
(setq gc-cons-threshold most-positive-fixnum)

;; Suppress compiler warnings for deprecated cl package (from packages like Evil)
(setq byte-compile-warnings '(not cl-functions obsolete))

;; Don't show warnings about obsolete functions during package loading
(setq warning-minimum-level :error)

;; Restore GC threshold after startup
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 100 1024 1024)))) ; 100MB

;; Disable package.el in favor of straight.el or manual management
;; (We'll enable it in init.el)
(setq package-enable-at-startup nil)

;; Faster to disable these here than in init.el
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)

;;; early-init.el ends here
#+end_src

* System Requirements
Before using this configuration, install the following packages on your Arch system:
** Core tools
#+begin_src bash :tangle no
# Package manager and Git
sudo pacman -S git ripgrep

# Language servers
sudo pacman -S python-lsp-server gopls clang typescript-language-server

# Debuggers (for dape)
sudo pacman -S gdb lldb delve  # C/C++, Go debuggers
#+end_src

** AUR packages (using yay or paru)
#+begin_src bash :tangle no
# JSON language server
yay -S vscode-json-languageserver

# YAML language server
yay -S yaml-language-server-bin

# Terraform language server
yay -S terraform-ls

# Dockerfile language server
yay -S dockerfile-language-server-bin

# GitHub CLI (optional, for project creation)
yay -S github-cli

#+end_src

** Alternative installation via npm
#+begin_src bash :tangle no
# If you prefer npm installation:
npm install -g vscode-langservers-extracted  # includes json-languageserver
npm install -g yaml-language-server
npm install -g @ansible/ansible-language-server  # if you use Ansible
#+end_src

** Python debugger
#+begin_src bash :tangle no
# For Python debugging with dape
pip install debugpy
#+end_src

* Package Setup
#+begin_src emacs-lisp
;; Package setup
(require 'package)
(add-to-list 'package-archives '("melpa" . "https://melpa.org/packages/") t)
(add-to-list 'package-archives '("melpa-stable" . "https://stable.melpa.org/packages/") t)
(package-initialize)

;; Bootstrap use-package
(unless (package-installed-p 'use-package)
  (package-refresh-contents)
  (package-install 'use-package))

;; Load use-package
(require 'use-package)
(setq use-package-always-ensure t)

;; Suppress additional byte-compilation warnings
(setq byte-compile-warnings '(not obsolete cl-functions))
#+end_src

* UI Settings
#+begin_src emacs-lisp
;; Remove window decorations
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)

;; Remove startup screen
(setq inhibit-startup-screen t)

;; Load theme
(load-file (expand-file-name "config/theme.el" user-emacs-directory))

;; Set font
(set-face-attribute 'default nil :font "CaskaydiaMono Nerd Font" :height 180)
#+end_src

* Editor Settings
#+begin_src emacs-lisp
;;Turn off beep
(setq ring-bell-function 'ignore)

;; Relative line numbers for text files
(add-hook 'text-mode-hook 'display-line-numbers-mode)
(add-hook 'prog-mode-hook 'display-line-numbers-mode)
(setq display-line-numbers-type 'relative)

;; Delete selection mode
(delete-selection-mode 1)

;; Show matching parentheses
(show-paren-mode 1)

;; Highlight current line
(global-hl-line-mode 1)

;; Scroll settings
(setq scroll-margin 10)
(setq scroll-conservatively 101)
(setq hscroll-margin 8)
(setq auto-hscroll-mode t)

;; Change where file backups are created (file~)
(setq backup-directory-alist '(("." . "~/.emacs.d/backups")))

;; Change where auto-save files are created (#file#)
(setq auto-save-file-name-transforms
      '((".*" "~/.emacs.d/auto-saves/" t)))

;; Create auto-saves directory if it doesn't exist
(make-directory "~/.emacs.d/auto-saves/" t)

;; Disable lock files (.#file)
(setq create-lockfiles nil)

;; Recent file setting 
(recentf-mode 1)
(setq recentf-max-saved-items 100)
#+end_src

* Evil Mode Setup
#+begin_src emacs-lisp
;; Setup undo-tree BEFORE evil-mode
(use-package undo-tree
  :config
  (global-undo-tree-mode)
  ;; Undo-tree history files
  (setq undo-tree-history-directory-alist '(("." . "~/.emacs.d/undo-tree")))
  (make-directory "~/.emacs.d/undo-tree/" t)
  ;; Tell evil to use undo-tree
  (setq evil-undo-system 'undo-tree))

;; Evil collection must be set up BEFORE evil-mode is enabled
(setq evil-want-integration t)
(setq evil-want-keybinding nil)

;; Evil mode
(use-package evil
  :init
  (setq evil-want-C-u-scroll t)  ; Use C-u for scrolling
  :config
  (evil-mode 1)
  
  ;; Make C-p and C-n work for line navigation in all Evil states
  (define-key evil-insert-state-map (kbd "C-p") 'previous-line)
  (define-key evil-insert-state-map (kbd "C-n") 'next-line))

;; Evil collection for better vim bindings everywhere
(use-package evil-collection
  :after evil
  :config
  (evil-collection-init))
#+end_src

* Completion Framework
** Vertico - Vertical completion UI
#+begin_src emacs-lisp
(defun dw/minibuffer-backward-kill ()
  "Delete to parent dir in file paths, else delete backward char."
  (interactive)
  (if minibuffer-completing-file-name
      (if (string-match-p "/." (minibuffer-contents))
          (zap-up-to-char -1 ?/)
        (delete-minibuffer-contents))
    (delete-backward-char 1)))

(use-package vertico
  :ensure t
  :init
  (setq completion-styles '(basic substring partial-completion flex)
        completion-ignore-case t
        read-file-name-completion-ignore-case t
        read-buffer-completion-ignore-case t
        enable-recursive-minibuffers t)
  
  (setq vertico-cycle t
        vertico-count 10
        vertico-resize t)
  
  :config
  (vertico-mode)
  (vertico-indexed-mode)
  (vertico-reverse-mode)
  
  :bind (:map vertico-map
         ("M-DEL"         . dw/minibuffer-backward-kill)
         ("RET"           . vertico-directory-enter))
  
  :hook (rfn-eshadow-update-overlay . vertico-directory-tidy))

(use-package savehist
  :init
  (setq savehist-file (locate-user-emacs-file "savehist")
        savehist-additional-variables '(search-ring regexp-search-ring))
  :config
  (savehist-mode))

(icomplete-mode -1)

#+end_src

** Orderless - Flexible completion style
#+begin_src emacs-lisp
(use-package orderless
  :custom
  ;; Use orderless for most completions, with basic as fallback
  (completion-styles '(orderless basic))
  (completion-category-defaults nil)
  ;; File completion uses orderless + partial-completion for path expansion
  (completion-category-overrides '((file (styles orderless basic partial-completion))
                                   (buffer (styles orderless basic))
                                   (project-file (styles orderless basic))))
  ;; Case-insensitive completion
  :config
  (setq read-file-name-completion-ignore-case t
        read-buffer-completion-ignore-case t
        completion-ignore-case t))
#+end_src

** Marginalia - Annotations in completion
#+begin_src emacs-lisp
(use-package marginalia
  :init
  (marginalia-mode)
  :config
  (define-key minibuffer-local-map (kbd "M-A") 'marginalia-cycle))
#+end_src

** Embark - Context actions
#+begin_src emacs-lisp
(use-package embark
  :bind
  (("C-." . embark-act)         ; Pick an action
   ;; Don't bind M-. - let xref use it for go-to-definition
   ("C-h B" . embark-bindings)) ; Show all bindings
  :config
  ;; Show embark actions in a helpful buffer
  (setq prefix-help-command #'embark-prefix-help-command))

(use-package embark-consult
  :after (embark consult)
  :hook
  (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** Consult - Enhanced search/navigation
#+begin_src emacs-lisp
;; Configure xref to use consult for better UI
(use-package xref
  :ensure nil  ; Built-in
  :config
  ;; Use Consult to select xref locations with preview
  (setq xref-show-xrefs-function       #'consult-xref
        xref-show-definitions-function #'consult-xref))

(use-package consult
  :bind (;; C-x bindings (ctl-x-map)
         ("C-x b" . consult-buffer)
         ("C-x 4 b" . consult-buffer-other-window)
         ("C-x 5 b" . consult-buffer-other-frame)
         ("C-x r b" . consult-bookmark)
         ("C-x r x" . consult-register)
         ;; M-s bindings (search-map)
         ("M-s s" . consult-find)
         ("M-s /" . consult-ripgrep)
         ("M-s b" . consult-buffer)
         ("M-s r" . consult-recent-file)
         ("M-s l" . consult-line)
         ("M-s L" . consult-line-multi)
         ;; Isearch integration
         ("C-s" . consult-line)
         ("C-S-s" . consult-line-multi)
         ;; Other
         ("M-y" . consult-yank-pop)
         ("C-h i" . consult-info)
         ("C-c m" . consult-mode-command)
         ("C-c k" . consult-keep-lines))
  :config
  ;; Configure consult-find to show hidden files
  (setq consult-find-args "find . -not ( -path '*/.git/*' -prune )")
  
  ;; Configure consult-ripgrep to search hidden files
  (setq consult-ripgrep-args
        "rg --null --line-buffered --color=never --max-columns=1000 \
--path-separator / --smart-case --no-heading --with-filename \
--line-number --search-zip --hidden --glob=!.git/")
  
  ;; Preview settings
  (setq consult-preview-key 'any)
  (setq consult-narrow-key "<"))

;; Dired integration for consult keybindings
(defun my/dired-setup-consult-keys ()
  "Set up consult keybindings for dired mode."
  (define-key dired-mode-map (kbd "M-s s") 'consult-find)
  (define-key dired-mode-map (kbd "M-s /") 'consult-ripgrep)
  (define-key dired-mode-map (kbd "M-s b") 'consult-buffer)
  (define-key dired-mode-map (kbd "M-s r") 'consult-recent-file)
  
  ;; Also bind in evil states if evil is loaded
  (when (featurep 'evil)
    (dolist (state '(normal visual motion insert))
      (evil-define-key state dired-mode-map
        (kbd "M-s s") 'consult-find
        (kbd "M-s /") 'consult-ripgrep
        (kbd "M-s b") 'consult-buffer
        (kbd "M-s r") 'consult-recent-file))))

(with-eval-after-load 'dired
  (my/dired-setup-consult-keys)
  (add-hook 'dired-mode-hook #'my/dired-setup-consult-keys t))
#+end_src

** Corfu - In-buffer completion
#+begin_src emacs-lisp
(use-package corfu
  :custom
  ;; Disable auto-completion - require manual trigger
  (corfu-auto nil)
  ;; Corfu behavior
  (corfu-cycle t)                ; Enable cycling
  (corfu-separator ?\s)          ; Use space as separator
  (corfu-quit-at-boundary t)     ; Quit at completion boundary
  (corfu-quit-no-match t)        ; Quit if no match
  (corfu-preview-current nil)    ; Don't preview current
  (corfu-preselect 'prompt)      ; Preselect prompt
  (corfu-scroll-margin 5)        ; Margin for scrolling
  :init
  (global-corfu-mode)
  :config
  ;; Keybindings for corfu-map
  (define-key corfu-map (kbd "TAB") 'corfu-next)
  (define-key corfu-map (kbd "<tab>") 'corfu-next)
  (define-key corfu-map (kbd "S-TAB") 'corfu-previous)
  (define-key corfu-map (kbd "<backtab>") 'corfu-previous)
  (define-key corfu-map (kbd "RET") 'corfu-insert)
  (define-key corfu-map (kbd "<return>") 'corfu-insert)
  
  ;; Manual completion trigger - bind to M-/
  (global-set-key (kbd "M-/") 'completion-at-point))

;; Corfu extensions
(use-package corfu-popupinfo
  :ensure nil  ; Built into corfu package
  :after corfu
  :hook (corfu-mode . corfu-popupinfo-mode)
  :custom
  (corfu-popupinfo-delay '(0.5 . 0.2)))
#+end_src

** Cape - Completion backends
#+begin_src emacs-lisp
(use-package cape
  :init
  ;; Add completion backends to completion-at-point-functions
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  :config
  ;; Silence the pcomplete capf, no errors or messages!
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-silent))
#+end_src

* Compilation
#+begin_src emacs-lisp
;; Custom compilation error regexp for better error parsing
(with-eval-after-load 'compile
  (add-to-list 'compilation-error-regexp-alist 
               '("\\([a-zA-Z0-9\\.]+\\)(\\([0-9]+\\)\\(,\\([0-9]+\\)\\)?) \\(Warning:\\)?" 1 2 (4) (5))))

;; Flymake is available but not auto-started
;; Start manually with: M-x flymake-mode
;; Or add to specific mode hooks if desired

;; Compilation keybindings - Global (work in Emacs state)
(global-set-key (kbd "C-5") 'compile)
(global-set-key (kbd "C-4") 'recompile)

;; Evil mode keybindings for compilation
(with-eval-after-load 'evil
  ;; Define in all evil states so they work everywhere
  (dolist (state '(normal insert visual motion emacs))
    (evil-define-key state 'global (kbd "C-5") 'compile)
    (evil-define-key state 'global (kbd "C-4") 'recompile)))
#+end_src

* Project Management
#+begin_src emacs-lisp
;; Projectile - Project management and navigation
(use-package projectile
  :ensure t
  :init
  ;; Refresh package contents if projectile isn't available
  (unless (package-installed-p 'projectile)
    (package-refresh-contents))
  
  :config
  ;; Enable projectile globally
  (projectile-mode +1)
  
  ;; Allow projectile to work outside project roots
  (setq projectile-require-project-root nil)
  
  ;; Project root markers (top-down search from current directory upward)
  (setq projectile-project-root-files
        '(".projectile" ".git" ".hg" ".bzr" "_darcs"))
  
  ;; Bottom-up markers (found in many directories, stops at first match going up)
  ;; Include both "makefile" (lowercase, used by exercism C exercises) and "Makefile"
  (setq projectile-project-root-files-bottom-up
        '(".projectile" ".git" ".hg" ".svn" "CVS" "makefile" "Makefile" "CMakeLists.txt"
          "compile_commands.json" "go.mod" "package.json" "Cargo.toml"
          "pyproject.toml" "setup.py" "build.gradle" "pom.xml"))
  
  ;; Functions to detect project root (in order of precedence)
  (setq projectile-project-root-files-functions
        '(projectile-root-local
          projectile-root-bottom-up
          projectile-root-top-down
          projectile-root-top-down-recurring))
  
  ;; Completion system - use default (works with vertico/consult)
  (setq projectile-completion-system 'default)
  
  ;; Indexing method - use native for speed
  (setq projectile-indexing-method 'native)
  
  ;; Cache project files for better performance
  (setq projectile-enable-caching t)
  
  ;; Show project name in mode line
  (setq projectile-mode-line-prefix " Proj")
  
  ;; Project types - automatically detect project structure
  ;; Projectile knows about git, Makefile, CMakeLists.txt, etc.
  
  ;; Keybindings - Global (work without Evil)
  (define-key projectile-mode-map (kbd "C-c p") 'projectile-command-map)
  
  ;; Common projectile commands:
  ;; C-c p p - Switch project
  ;; C-c p f - Find file in project
  ;; C-c p s r - Search in project (ripgrep)
  ;; C-c p c - Compile project
  ;; C-c p ! - Run shell command in project root
  ;; C-c p d - Find directory in project
  ;; C-c p b - Switch to project buffer (use consult for better UX)
  ;; C-c p k - Kill all project buffers
  ;; C-c p D - Open project root in dired
  )

;; Use consult for better project buffer switching
(with-eval-after-load 'projectile
  (define-key projectile-mode-map (kbd "C-c p b") 'consult-project-buffer))
#+end_src

* Dired
#+begin_src emacs-lisp
;; Hide dotfiles by default
(use-package dired-hide-dotfiles
  :hook (dired-mode . dired-hide-dotfiles-mode)
  :config
  ;; Standard Emacs binding
  (define-key dired-mode-map "." 'dired-hide-dotfiles-mode)
  
  ;; Evil mode binding
  (with-eval-after-load 'evil
    (evil-define-key 'normal dired-mode-map (kbd ".") 'dired-hide-dotfiles-mode)))
#+end_src

* Tree-sitter
#+begin_src emacs-lisp
;; Tree-sitter support (built-in for Emacs 29+)
(when (and (fboundp 'treesit-available-p)
           (treesit-available-p))
  
  ;; Set up tree-sitter grammar sources
  (setq treesit-language-source-alist
        '((bash "https://github.com/tree-sitter/tree-sitter-bash")
          (c "https://github.com/tree-sitter/tree-sitter-c")
          (cpp "https://github.com/tree-sitter/tree-sitter-cpp")
          (css "https://github.com/tree-sitter/tree-sitter-css")
          (go "https://github.com/tree-sitter/tree-sitter-go")
          (html "https://github.com/tree-sitter/tree-sitter-html")
          (javascript "https://github.com/tree-sitter/tree-sitter-javascript")
          (json "https://github.com/tree-sitter/tree-sitter-json")
          (python "https://github.com/tree-sitter/tree-sitter-python")
          (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
          (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
          (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
  
  ;; Manual installation function (run this once: M-x my/install-tree-sitter-grammars)
  (defun my/install-tree-sitter-grammars ()
    "Install all configured tree-sitter grammars.
Run this manually on first install to avoid blocking Emacs startup."
    (interactive)
    (dolist (lang treesit-language-source-alist)
      (unless (treesit-language-available-p (car lang))
        (message "Installing tree-sitter grammar for %s..." (car lang))
        (treesit-install-language-grammar (car lang)))))
  
  ;; treesit-auto: automatically use tree-sitter modes when available
  ;; This will prompt you to install grammars on-demand when you open files
  (use-package treesit-auto
    :demand t
    :config
    ;; Prompt to install grammars when needed (not at startup)
    (setq treesit-auto-install 'prompt)
    ;; Enable globally
    (global-treesit-auto-mode)))
#+end_src

* Programming - LSP & Completion
** Dumb-jump - Code navigation without LSP
#+begin_src emacs-lisp
;; Dumb-jump: Jump to definitions using grep/ripgrep/ag
;; Works without LSP, great for system headers like stdio.h
(use-package dumb-jump
  :init
  ;; CRITICAL: Use 'append to let Eglot/LSP run first!
  ;; This makes dumb-jump a fallback when LSP doesn't know the definition
  (add-hook 'xref-backend-functions #'dumb-jump-xref-activate 'append)
  
  :config
  ;; Disable etags backend to prevent TAGS file errors
  (remove-hook 'xref-backend-functions #'etags--xref-backend)
  
  ;; Performance & Searcher settings
  (setq dumb-jump-force-searcher 'rg)        ; Force Ripgrep
  (setq dumb-jump-default-project "~/projects")
  (setq dumb-jump-selector 'completing-read) ; Use Vertico for selection
  (setq dumb-jump-aggressive nil)
  (setq dumb-jump-max-find-time 10)

  ;; IMPORTANT: All setq for dumb-jump-project-denoters must be in :config
  ;; so it runs AFTER dumb-jump loads and doesn't get clobbered by defcustom.
  ;; Include both "makefile" (lowercase, exercism/C) and "Makefile" (standard).
  (setq dumb-jump-project-denoters
        '(".git" ".hg" ".projectile" "makefile" "Makefile" "CMakeLists.txt"
          "compile_commands.json" "go.mod" "package.json" "Cargo.toml"
          "pyproject.toml" "setup.py"))

  ;; Ensure .h and .c files are both searched for C/C++
  (add-to-list 'dumb-jump-language-file-exts '(:language "c" :ext "h" :agtype "cc" :rgtype "c"))
  (add-to-list 'dumb-jump-language-file-exts '(:language "c++" :ext "hpp" :agtype "cc" :rgtype "cpp"))
  (add-to-list 'dumb-jump-language-file-exts '(:language "c++" :ext "hh" :agtype "cc" :rgtype "cpp"))

  ;; Keybindings
  ;; Note: M-. and M-, work automatically via xref integration
  ;; These are for forcing dumb-jump explicitly (bypassing LSP)
  (global-set-key (kbd "C-M-g") 'dumb-jump-go)
  (global-set-key (kbd "C-M-p") 'dumb-jump-back)
  (global-set-key (kbd "C-M-j") 'dumb-jump-go-prompt)

  ;; Evil keybindings - use xref functions
  (with-eval-after-load 'evil
    (dolist (state '(normal insert visual motion emacs))
      (evil-define-key state 'global (kbd "M-.") 'xref-find-definitions)
      (evil-define-key state 'global (kbd "M-,") 'xref-go-back))))


;; Direct search in /usr/include
(defun my/search-system-headers ()
  "Search for symbol at point in /usr/include system headers."
  (interactive)
  (let ((dumb-jump-default-project "/usr/include")
        (dumb-jump-project-denoters nil))
    (message "Searching /usr/include...")
    (dumb-jump-go)))

;; Find a header FILE by name in /usr/include
;; Use this when you have "stdio.h" highlighted and want to open the actual file.
;; M-s h → search for definitions containing the word (ripgrep inside files)
;; M-s H → find the header file itself by name (find -name)
(defun my/find-system-header-file ()
  "Find a header file by name in /usr/include.
Uses region if active, otherwise word at point (adds .h if no extension)."
  (interactive)
  (let* ((raw (if (use-region-p)
                  (buffer-substring-no-properties (region-beginning) (region-end))
                (thing-at-point 'filename t)))
         ;; If no extension detected, assume .h
         (name (if (and raw (string-match-p "\\." raw))
                   raw
                 (concat raw ".h")))
         (results (split-string
                   (shell-command-to-string
                    (format "find /usr/include -name '%s' 2>/dev/null" name))
                   "\n" t)))
    (cond
     ((null results)
      (message "No header file found for: %s" name))
     ((= 1 (length results))
      (find-file (car results))
      (message "Opened: %s" (car results)))
     (t
      ;; Multiple matches - use completing-read to pick one
      (let ((chosen (completing-read
                     (format "Find header (%s): " name)
                     results nil t)))
        (find-file chosen))))))

;; Bind to M-s h → content search, M-s H → file finder
(global-set-key (kbd "M-s h") 'my/search-system-headers)
(global-set-key (kbd "M-s H") 'my/find-system-header-file)

;; Keybinding reference:
;; M-. or g d → Smart jump (LSP → dumb-jump in current project)
;; M-, or g b → Go back
;; C-M-g → Force dumb-jump (bypass LSP)
;; C-M-j → Prompt for custom search directory
;; M-s h → Search for symbol definition in /usr/include (ripgrep inside files)
;; M-s H → Find header FILE by name in /usr/include (e.g. highlight stdio.h → opens it)
#+end_src

** Eglot LSP
#+begin_src emacs-lisp
;; Manual LSP start keybinding (before use-package so it's always available)
(global-set-key (kbd "C-c l l") 'eglot)

(use-package eglot
  :ensure nil  ; Built-in for Emacs 29+
  :config
  ;; Keybindings (must be in :config since eglot-mode-map isn't defined until eglot loads)
  (define-key eglot-mode-map (kbd "C-c l a") 'eglot-code-actions)
  (define-key eglot-mode-map (kbd "C-c l r") 'eglot-rename)
  (define-key eglot-mode-map (kbd "C-c l f") 'eglot-format)
  (define-key eglot-mode-map (kbd "C-c l d") 'eglot-find-declaration)
  (define-key eglot-mode-map (kbd "C-c l i") 'eglot-find-implementation)
  (define-key eglot-mode-map (kbd "C-c l t") 'eglot-find-typeDefinition)
  (define-key eglot-mode-map (kbd "C-c l h") 'eldoc-doc-buffer)
  (define-key eglot-mode-map (kbd "C-c l s") 'eglot-reconnect)
  
  ;; Optimize performance
  (setq eglot-events-buffer-size 0)  ; Disable event logging
  (setq eglot-sync-connect nil)      ; Async connection
  
  ;; Configure TypeScript language server
  (add-to-list 'eglot-server-programs
               '((js-mode js-ts-mode typescript-mode typescript-ts-mode tsx-ts-mode)
                 . ("typescript-language-server" "--stdio"))))
#+end_src

** Language-specific modes
#+begin_src emacs-lisp
;; Go
(use-package go-mode
  :mode "\\.go\\'")

;; TypeScript/JavaScript
(use-package typescript-mode
  :mode (("\\.ts\\'" . typescript-mode)
         ("\\.tsx\\'" . tsx-ts-mode)))

;; JSON
(use-package json-mode
  :mode "\\.json\\'")

;; YAML
(use-package yaml-mode
  :mode "\\.ya?ml\\'")

;; Terraform
(use-package terraform-mode
  :mode "\\.tf\\'")

;; Dockerfile
(use-package dockerfile-mode
  :mode "Dockerfile\\'")

;; Kubernetes & Helm YAML files
(add-to-list 'auto-mode-alist '("\\.k8s\\.ya?ml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("k8s/.*\\.ya?ml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("Chart\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("values\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("templates/.*\\.yaml\\'" . yaml-mode))
(add-to-list 'auto-mode-alist '("templates/.*\\.tpl\\'" . yaml-mode))
#+end_src

* Debugging with Dape
#+begin_src emacs-lisp
(use-package dape
  :config
  ;; Save buffers on startup
  (add-hook 'dape-on-start-hooks (lambda () (save-some-buffers t t)))
  
  ;; Kill compile buffer on build success
  (add-hook 'dape-compile-compile-hook 'kill-buffer)
  
  ;; Use project root as working directory
  (setq dape-cwd-fn 'dape--default-cwd)
  
  ;; Global debugging keybindings
  :bind (("C-c d d" . dape)
         ("C-c d p" . dape-pause)
         ("C-c d c" . dape-continue)
         ("C-c d n" . dape-next)
         ("C-c d s" . dape-step-in)
         ("C-c d o" . dape-step-out)
         ("C-c d r" . dape-restart)
         ("C-c d k" . dape-kill)
         ("C-c d q" . dape-quit)
         ("C-c d b" . dape-breakpoint-toggle)
         ("C-c d l" . dape-breakpoint-log)
         ("C-c d e" . dape-breakpoint-expression)
         ("C-c d w" . dape-watch-dwim)
         ("C-c d i" . dape-info)
         ("C-c d R" . dape-repl)))

;; Dape configurations for different languages
;; Note: dape-buffer-default is a special symbol that dape expands to the current buffer's file
(with-eval-after-load 'dape
  ;; Python (debugpy) - install with: pip install debugpy
  (add-to-list 'dape-configs
               `(debugpy
                 modes (python-mode python-ts-mode)
                 command "python"
                 command-args ("-m" "debugpy.adapter")
                 :request "launch"
                 :type "executable"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))
  
  ;; Go (delve) - install with: go install github.com/go-delve/delve/cmd/dlv@latest
  (add-to-list 'dape-configs
               `(delve
                 modes (go-mode go-ts-mode)
                 command "dlv"
                 command-args ("dap" "--listen" "127.0.0.1:55878")
                 command-cwd dape-cwd-fn
                 port 55878
                 :request "launch"
                 :type "debug"
                 :mode "debug"
                 :program dape-cwd-fn))
  
  ;; C/C++ (gdb)
  (add-to-list 'dape-configs
               `(gdb
                 modes (c-mode c++-mode c-ts-mode c++-ts-mode)
                 command "gdb"
                 command-args ("-i" "dap")
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "executable"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))
  
  ;; C/C++ (lldb) - alternative to gdb
  (add-to-list 'dape-configs
               `(lldb
                 modes (c-mode c++-mode c-ts-mode c++-ts-mode)
                 command "lldb-vscode"
                 command-args ()
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "lldb"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))
  
  ;; Node.js (for JavaScript/TypeScript debugging)
  (add-to-list 'dape-configs
               `(node
                 modes (js-mode js-ts-mode typescript-mode typescript-ts-mode)
                 command "node"
                 command-args ("--inspect-brk" dape-buffer-default)
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "node"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default)))
#+end_src

* Org Mode
#+begin_src emacs-lisp
;; Org mode basic settings
(setq org-startup-indented t)
(setq org-hide-leading-stars t)

;; Enable folding (TAB to toggle)
(setq org-startup-folded 'content)

;; Syntax highlighting in code blocks
(setq org-src-fontify-natively t)
(setq org-src-tab-acts-natively t)

;; Enable Babel for code execution
(org-babel-do-load-languages
 'org-babel-load-languages
 '((emacs-lisp . t)
   (python . t)
   (C . t)
   (shell . t)
   (js . t)))

;; Don't ask for confirmation before executing code blocks
(setq org-confirm-babel-evaluate nil)

;; Better code block editing
(setq org-edit-src-content-indentation 0)
(setq org-src-preserve-indentation t)
(setq org-src-window-setup 'current-window)

;; Enable eglot in org-src edit buffers
(defun my/org-babel-edit-prep (info)
  "Enable eglot in org src blocks by setting buffer-file-name."
  (setq buffer-file-name (or (alist-get :file (caddr info))
                             "org-src-babel-tmp"))
  (when (derived-mode-p 'prog-mode)
    (eglot-ensure)))

(advice-add 'org-edit-src-code
            :before
            (defun my/org-edit-src-code-advice (&rest args)
              (when-let* ((element (org-element-at-point))
                          (type (org-element-type element))
                          (lang (org-element-property :language element))
                          (mode (org-src-get-lang-mode lang))
                          ((eglot--lookup-mode mode))
                          (edit-prep (intern (format "org-babel-edit-prep:%s" lang))))
                (unless (fboundp edit-prep)
                  (fset edit-prep #'my/org-babel-edit-prep)))))

;; Keybindings for org-mode
(with-eval-after-load 'org
  (define-key org-mode-map (kbd "C-c C-c") 'org-ctrl-c-ctrl-c)
  (define-key org-mode-map (kbd "C-c '") 'org-edit-special))

;; Org-modern for beautiful org-mode appearance
(use-package org-modern
  :hook ((org-mode . org-modern-mode)
         (org-agenda-finalize . org-modern-agenda))
  :custom
  ;; Modern styling
  (org-modern-star '("●" "○" "✸" "✿"))
  (org-modern-table nil)  ; Set to t if you want modern table styling
  (org-modern-hide-stars nil)  ; Show decorative stars
  (org-modern-block-fringe nil)
  
  ;; Checkbox styling
  (org-modern-checkbox
   '((?X . "☑")
     (?- . "⊟")
     (?\s . "☐")))
  
  ;; Tag styling
  (org-modern-tag t)
  (org-modern-priority t)
  
  ;; Keyword styling
  (org-modern-keyword t)
  (org-modern-timestamp t)
  (org-modern-statistics t)
  
  ;; Block styling
  (org-modern-block-name t)
  
  ;; List styling  
  (org-modern-list
   '((?+ . "◦")
     (?- . "–")
     (?* . "•"))))

;; Additional visual improvements for org-mode
(with-eval-after-load 'org
  ;; Better heading sizes
  (custom-set-faces
   '(org-level-1 ((t (:height 1.3 :weight bold))))
   '(org-level-2 ((t (:height 1.2 :weight semi-bold))))
   '(org-level-3 ((t (:height 1.1 :weight semi-bold))))
   '(org-document-title ((t (:height 1.5 :weight bold)))))
  
  ;; Better spacing
  (setq org-cycle-separator-lines 2))
#+end_src

* Terminal
#+begin_src emacs-lisp
;; Vterm - best terminal emulator for Emacs
(use-package vterm
  :config
  (setq vterm-always-compile-module t)
  (setq vterm-max-scrollback 10000)
  
  ;; Disable Evil mode in vterm
  (evil-set-initial-state 'vterm-mode 'emacs)
  
  ;; Fix colors - use faces that match your theme
  (setq vterm-term-environment-variable "xterm-256color")
  
  ;; Set vterm colors to match your Menudo theme
  (defun my/vterm-setup-colors ()
    "Set vterm colors to match Menudo theme."
    (setq vterm-color-black "#000000"
          vterm-color-red "#dc322f"
          vterm-color-green "#66bc11"
          vterm-color-yellow "#b58900"
          vterm-color-blue "#268bd2"
          vterm-color-magenta "#af87d7"
          vterm-color-cyan "#5fafaf"
          vterm-color-white "#cccccc"
          ;; Bright colors
          vterm-color-bright-black "#666666"
          vterm-color-bright-red "#dc7575"
          vterm-color-bright-green "#66bc11"
          vterm-color-bright-yellow "#f0bb0c"
          vterm-color-bright-blue "#268bd2"
          vterm-color-bright-magenta "#af87d7"
          vterm-color-bright-cyan "#5fafaf"
          vterm-color-bright-white "#cccccc"))
  
  (add-hook 'vterm-mode-hook #'my/vterm-setup-colors))
#+end_src
  
* Visual Enhancements
#+begin_src emacs-lisp
;; Rainbow delimiters - colorful parentheses
(use-package rainbow-delimiters
  :hook ((prog-mode . rainbow-delimiters-mode)
         (emacs-lisp-mode . rainbow-delimiters-mode)
         (lisp-mode . rainbow-delimiters-mode)
         (scheme-mode . rainbow-delimiters-mode)))
#+end_src

* Version Control
#+begin_src emacs-lisp
;; Magit - best Git interface
(use-package magit
  :bind ("C-x g" . magit-status)
  :config
  ;; Show word-granularity diff
  (setq magit-diff-refine-hunk 'all))

;; Diff-hl - show git changes in gutter
(use-package diff-hl
  :hook ((prog-mode . diff-hl-mode)
         (org-mode . diff-hl-mode)
         (dired-mode . diff-hl-dired-mode)
         (magit-post-refresh . diff-hl-magit-post-refresh)))
#+end_src

* Custom Functions
** Project Navigation and Management
*** Directory Candidates Helper
#+begin_src emacs-lisp
(defvar my/directory-history nil
  "History for directory selection.")

(defvar my/base-directories '("~/projects" "~/exercism" "~/.config" "~")
  "Base directories to scan for projects.")

(defun my/get-directory-candidates ()
  "Get list of directories from common project locations."
  (let ((dirs '()))
    (dolist (base-dir my/base-directories)
      (let ((expanded (expand-file-name base-dir)))
        (when (file-directory-p expanded)
          (push expanded dirs)
          (when-let ((subdirs (directory-files expanded t directory-files-no-dot-files-regexp t)))
            (dolist (subdir subdirs)
              (when (file-directory-p subdir)
                (push subdir dirs)))))))
    (nreverse dirs)))
#+end_src
*** Consult-Based Navigation (Integrated with Projectile)
#+begin_src emacs-lisp
(defun my/consult-sessionizer ()
  "Consult-based directory selection from custom folders.
Opens selected directory in dired and adds to projectile known projects."
  (interactive)
  (require 'consult)
  (let ((candidates (my/get-directory-candidates)))
    (if candidates
        (when-let ((selected
                    (consult--read candidates
                                   :prompt "Select directory: "
                                   :require-match t
                                   :sort nil
                                   :category 'file
                                   :history 'my/directory-history)))

          (unless (or (file-exists-p (expand-file-name ".git" selected))
                      (file-exists-p (expand-file-name ".hg" selected))
                      (file-exists-p (expand-file-name "Makefile" selected))
                      (file-exists-p (expand-file-name "makefile" selected))
                      (file-exists-p (expand-file-name "CMakeLists.txt" selected))
                      (file-exists-p (expand-file-name "compile_commands.json" selected))
                      (file-exists-p (expand-file-name "go.mod" selected))
                      (file-exists-p (expand-file-name "package.json" selected))
                      (file-exists-p (expand-file-name "Cargo.toml" selected))
                      (file-exists-p (expand-file-name ".projectile" selected)))
            (write-region "" nil (expand-file-name ".projectile" selected)))

          (dired selected)

          (when (fboundp 'projectile-add-known-project)
            (projectile-add-known-project selected))

          (message "Opened: %s (added to projectile)" selected))
      (dired default-directory)
      (message "No project directories found. Opened current directory."))))
#+end_src

*** Project Creation
#+begin_src emacs-lisp
(defun my/git-init-and-commit (project-dir project-name)
  "Initialize git repo and create initial commit."
  (let ((default-directory project-dir))
    (call-process "git" nil nil nil "init" "-b" "main")

    (with-temp-file (expand-file-name "README.md" project-dir)
      (insert (format "# %s\n\nProject description\n" project-name)))

    (call-process "git" nil nil nil "add" "README.md")
    (call-process "git" nil nil nil "commit" "-m" "initial commit")))

(defun my/create-github-repo (project-name visibility)
  "Create GitHub repository."
  (let ((command
         (format "gh repo create %s %s --source=. --remote=origin --push"
                 project-name visibility)))
    (call-process-shell-command command)))

(defun my/create-new-project ()
  "Create new project directory with git and optional GitHub setup."
  (interactive)
  (let* ((project-name (string-trim (read-string "Project name: ")))
         (project-dir (expand-file-name project-name "~/projects"))
         (gh-available (executable-find "gh"))
         (create-github (and gh-available
                             (y-or-n-p "Create GitHub repository? ")))
         (visibility (when create-github
                       (if (y-or-n-p "Public repository? ")
                           "--public"
                         "--private"))))

    (when (string-empty-p project-name)
      (user-error "Project name cannot be empty"))

    (make-directory project-dir t)

    (unless (file-exists-p (expand-file-name ".git" project-dir))
      (my/git-init-and-commit project-dir project-name)
      (when create-github
        (my/create-github-repo project-name visibility)))

    (dired project-dir)))
#+end_src

*** GitHub PR Helper
#+begin_src emacs-lisp
(defun my/get-git-info ()
  "Get git remote URL and current branch."
  (when (locate-dominating-file default-directory ".git")
    (let ((remote (string-trim
                   (shell-command-to-string
                    "git config --get remote.origin.url")))
          (branch (string-trim
                   (shell-command-to-string
                    "git rev-parse --abbrev-ref HEAD"))))
      (when (and (not (string-empty-p remote))
                 (not (string-empty-p branch)))
        (cons remote branch)))))

(defun my/convert-to-github-url (remote-url)
  "Convert git REMOTE-URL to GitHub HTTPS URL."
  (cond
   ((string-match "^git@github\\.com:\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   ((string-match "^https://github\\.com/\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   (t (error "Not a GitHub repository"))))

(defun my/open-github-pr ()
  "Open GitHub compare page for current branch."
  (interactive)
  (if-let* ((git-info (my/get-git-info))
            (remote-url (car git-info))
            (branch (cdr git-info))
            (github-url (my/convert-to-github-url remote-url)))
      (browse-url (concat github-url "/compare/" branch))
    (user-error "Not in a git repository")))
#+end_src

*** Keybindings
#+begin_src emacs-lisp
(global-set-key (kbd "C-c p s") #'my/consult-sessionizer)
(global-set-key (kbd "C-c p n") #'my/create-new-project)
(global-set-key (kbd "C-c p r") #'my/open-github-pr)

(with-eval-after-load 'evil
  (dolist (state '(normal insert visual motion emacs))
    (evil-define-key state 'global (kbd "C-S-f") #'my/consult-sessionizer)
    (evil-define-key state 'global (kbd "C-S-n") #'my/create-new-project)
    (evil-define-key state 'global (kbd "C-S-p") #'my/open-github-pr)))
#+end_src

* Performance Optimizations
#+begin_src emacs-lisp
;; Note: GC threshold is set in early-init.el and reset after startup
;; These are additional runtime optimizations

;; Increase amount of data read from processes (important for LSP)
(setq read-process-output-max (* 1024 1024))  ; 1MB

;; Reduce rendering overhead
(setq redisplay-skip-fontification-on-input t)

;; Reduce frequency of garbage collection by making it happen on idle
(run-with-idle-timer 5 t #'garbage-collect)
#+end_src
