
#+TITLE: PrawnFarmerDev Emacs Configuration
#+PROPERTY: header-args:emacs-lisp :tangle ~/.emacs.d/init.el

* Early Init (Performance & Warning Suppression)
This section creates an early-init.el file for startup optimizations and warning suppression.
#+begin_src emacs-lisp :tangle ~/.emacs.d/early-init.el
;;; early-init.el --- Early initialization -*- lexical-binding: t; -*-

;; Increase GC threshold during startup for faster loading
(setq gc-cons-threshold most-positive-fixnum)

;; Suppress compiler warnings globally during startup
(setq byte-compile-warnings '(not cl-functions obsolete)
      warning-minimum-level :error)

;; Restore GC threshold and warning level after startup
(add-hook 'emacs-startup-hook
          (lambda ()
            (setq gc-cons-threshold (* 100 1024 1024)  ; 100MB
                  warning-minimum-level :warning)))

;; Disable package.el in favor of manual management in init.el
(setq package-enable-at-startup nil)

;; Disable UI elements early (faster than doing it in init.el)
;; NOTE: menu-bar-mode, tool-bar-mode, scroll-bar-mode calls in init.el are
;; redundant with these - they're kept there for clarity but these run first.
(push '(menu-bar-lines . 0) default-frame-alist)
(push '(tool-bar-lines . 0) default-frame-alist)
(push '(vertical-scroll-bars) default-frame-alist)

;;; early-init.el ends here
#+end_src

* System Requirements
Before using this configuration, install the following packages on your Arch system:
** Core tools
#+begin_src bash :tangle no
# Package manager and Git
sudo pacman -S git ripgrep

# Language servers
sudo pacman -S python-lsp-server gopls clang typescript-language-server

# Debuggers (for dape)
sudo pacman -S gdb lldb delve  # C/C++, Go debuggers

# Eldoc backends (no LSP needed)
go install github.com/rogpeppe/godef@latest  # go-eldoc

# Formatters for apheleia (format on save)
sudo pacman -S clang                  # clang-format for C/C++
pip install black                     # Python
npm install -g prettier               # JS/TS/JSON/YAML
# gofmt ships with Go - no extra install needed
#+end_src

** AUR packages (using yay or paru)
#+begin_src bash :tangle no
# JSON language server
yay -S vscode-json-languageserver

# YAML language server
yay -S yaml-language-server-bin

# Terraform language server
yay -S terraform-ls

# Dockerfile language server
yay -S dockerfile-language-server-bin

# GitHub CLI (optional, for project creation)
yay -S github-cli
#+end_src

** Alternative installation via npm
#+begin_src bash :tangle no
# If you prefer npm installation:
npm install -g vscode-langservers-extracted  # includes json-languageserver
npm install -g yaml-language-server
npm install -g @ansible/ansible-language-server  # if you use Ansible
#+end_src

** Python debugger
#+begin_src bash :tangle no
# For Python debugging with dape
pip install debugpy
#+end_src

* Package Setup
#+begin_src emacs-lisp
;;; init.el --- Main configuration -*- lexical-binding: t; -*-

;; Package setup
(require 'package)

(setq package-archives
      '(("melpa"        . "https://www.mirrorservice.org/sites/melpa.org/packages/")
        ("melpa-stable" . "https://www.mirrorservice.org/sites/stable.melpa.org/packages/")))

(condition-case nil
    (package-refresh-contents)
  (error
   (message "Falling back to MELPA mirror...")
   (setq package-archives
         '(("melpa"        . "https://melpa.org/packages/")
           ("melpa-stable" . "https://stable.melpa.org/packages/")))
   (package-refresh-contents)))

(package-initialize)

;; Bootstrap use-package
(unless (package-installed-p 'use-package)
  (package-install 'use-package))

(require 'use-package)
(setq use-package-always-ensure t)

;; Suppress byte-compilation warnings
(setq byte-compile-warnings '(not obsolete cl-functions))
#+end_src

* UI Settings
#+begin_src emacs-lisp
;; These calls are slightly redundant with early-init.el but kept for clarity
;; and to ensure the modes are properly tracked by Emacs internals.
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)

;; Remove startup screen
(setq inhibit-startup-screen t)

;; Load theme
(load-file (expand-file-name "config/theme.el" user-emacs-directory))

;; Set font
(set-face-attribute 'default nil :font "CaskaydiaMono Nerd Font" :height 180)

(set-frame-parameter nil 'alpha-background 95)
#+end_src

* Editor Settings
#+begin_src emacs-lisp
;; Turn off beep
(setq ring-bell-function 'ignore)

;; Relative line numbers - stable width so text doesn't jump at line 100/1000
(setq display-line-numbers-type  'relative
      display-line-numbers-width 4
      display-line-numbers-widen t)
(add-hook 'text-mode-hook #'display-line-numbers-mode)
(add-hook 'prog-mode-hook  #'display-line-numbers-mode)

;; Delete selection mode
(delete-selection-mode 1)

;; Electric pair (deferred - only needed when editing begins)
(use-package electric-pair
  :ensure nil
  :defer t
  :hook (after-init . electric-pair-mode))

;; Paren settings (deferred)
(use-package paren
  :ensure nil
  :defer t
  :hook (after-init . show-paren-mode)
  :custom
  (show-paren-delay 0)
  (show-paren-style 'mixed)
  (show-paren-context-when-offscreen t))

;; Highlight current line
(global-hl-line-mode 1)

;; Scroll settings
(setq scroll-margin 10
      scroll-conservatively 101
      hscroll-margin 8
      auto-hscroll-mode t)

;; Smooth pixel-level scrolling (Emacs 29+)
(pixel-scroll-precision-mode 1)

;; Prefer vertical (side-by-side) splits on widescreen monitors
(setq split-width-threshold  170
      split-height-threshold nil)

;; Disable line wrap
(setq-default truncate-lines t)

;; Keep kill-ring clean
(setq kill-do-not-save-duplicates t)

;; Walk back through mark ring with C-u C-SPC C-SPC C-SPC instead of repeating C-u
(setq set-mark-command-repeat-pop t)

;; Default to UTF-8 everywhere - prevents TSX/JSX buffers asking about encoding
(modify-coding-system-alist 'file "" 'utf-8)

;; Show diff before saving when prompted (press "d" at save-some-buffers prompt)
(add-to-list 'save-some-buffers-action-alist
             (list "d"
                   (lambda (buffer) (diff-buffer-with-file (buffer-file-name buffer)))
                   "show diff between the buffer and its file"))

;; Redirect noisy file clutter to organised cache/ directory
(let ((backup-dir   (expand-file-name "cache/backups/"    user-emacs-directory))
      (autosave-dir (expand-file-name "cache/auto-saves/" user-emacs-directory)))
  (make-directory backup-dir   t)
  (make-directory autosave-dir t)
  (setq backup-directory-alist         `(("." . ,backup-dir))
        auto-save-file-name-transforms `((".*" ,autosave-dir t))
        create-lockfiles nil))

;; Recent file settings
(use-package recentf
  :ensure nil
  :defer t
  :hook (after-init . recentf-mode)
  :custom
  (recentf-max-saved-items 300)
  (recentf-save-file      (expand-file-name "cache/recentf"  user-emacs-directory))
  ;; Don't block on cleanup when running as daemon
  (recentf-auto-cleanup   (if (daemonp) 300 'never))
  ;; Exclude remote/sudo files that can hang recentf
  (recentf-exclude        (list "^/\\(?:ssh\\|su\\|sudo\\)?:")))

;; savehist - persist minibuffer history across sessions
(use-package savehist
  :ensure nil
  :demand t
  :custom
  (savehist-file                 (expand-file-name "cache/history" user-emacs-directory))
  (savehist-additional-variables '(search-ring regexp-search-ring))
  :config
  (savehist-mode))

;; project.el - keep project list in cache/
(setq project-list-file (expand-file-name "cache/projects" user-emacs-directory))
#+end_src

* Evil Mode Setup
#+begin_src emacs-lisp
;; Setup undo-tree BEFORE evil-mode
(use-package undo-tree
  :defer t
  :config
  (let ((undo-dir (expand-file-name "undo-tree/" user-emacs-directory)))
    (make-directory undo-dir t)
    (setq undo-tree-history-directory-alist `(("." . ,undo-dir))))
  (setq evil-undo-system 'undo-tree)
  (global-undo-tree-mode))

;; These must be set before evil loads
(setq evil-want-integration t
      evil-want-keybinding nil)

;; Evil mode
(use-package evil
  :demand t
  :init
  (setq evil-want-C-u-scroll t)  ; Use C-u for scrolling
  :config
  (evil-mode 1)

  ;; Make C-p and C-n work for line navigation in insert state
  (define-key evil-insert-state-map (kbd "C-p") #'previous-line)
  (define-key evil-insert-state-map (kbd "C-n") #'next-line)

  ;; Buffer cycling - all evil states + vanilla Emacs
  (evil-define-key '(normal insert visual) 'global
    (kbd "C-S-h") #'previous-buffer
    (kbd "C-S-l") #'next-buffer)
  (global-set-key (kbd "C-S-h") #'previous-buffer)
  (global-set-key (kbd "C-S-l") #'next-buffer)
  (global-set-key (kbd "M-o")   #'other-window)
  (global-set-key (kbd "M-j")   #'duplicate-dwim)
  (global-set-key (kbd "C-M-z") #'delete-pair))

;; Evil collection for better vim bindings everywhere
(use-package evil-collection
  :after evil
  :demand t
  :config
  (evil-collection-init))
#+end_src

* Completion Framework
** Vertico - Vertical completion UI
#+begin_src emacs-lisp
(defun dw/minibuffer-backward-kill ()
  "Delete to parent dir in file paths, else delete backward char."
  (interactive)
  (if minibuffer-completing-file-name
      (if (string-match-p "/." (minibuffer-contents))
          (zap-up-to-char -1 ?/)
        (delete-minibuffer-contents))
    (delete-backward-char 1)))

(use-package vertico
  :demand t
  :custom
  (vertico-cycle  t)
  (vertico-count  10)
  (vertico-resize t)
  :init
  (setq completion-styles                     '(basic substring partial-completion flex)
        completion-ignore-case                t
        read-file-name-completion-ignore-case t
        read-buffer-completion-ignore-case    t
        enable-recursive-minibuffers          t)
  :config
  (vertico-mode)
  (vertico-indexed-mode)
  (vertico-reverse-mode)
  (icomplete-mode -1)
  :bind (:map vertico-map
         ("M-DEL" . dw/minibuffer-backward-kill)
         ("RET"   . vertico-directory-enter))
  :hook (rfn-eshadow-update-overlay . vertico-directory-tidy))

#+end_src

** Orderless - Flexible completion style
#+begin_src emacs-lisp
(use-package orderless
  :demand t
  :custom
  (completion-styles             '(orderless basic))
  (completion-category-defaults  nil)
  (completion-category-overrides '((file         (styles orderless basic partial-completion))
                                   (buffer        (styles orderless basic))
                                   (project-file  (styles orderless basic))))
  (read-file-name-completion-ignore-case t)
  (read-buffer-completion-ignore-case    t)
  (completion-ignore-case                t))
#+end_src

** Marginalia - Annotations in completion
#+begin_src emacs-lisp
(use-package marginalia
  :demand t
  :config
  (marginalia-mode)
  :bind (:map minibuffer-local-map
         ("M-A" . marginalia-cycle)))
#+end_src

** Embark - Context actions
#+begin_src emacs-lisp
(use-package embark
  :defer t
  :bind (("C-."   . embark-act)
         ("C-h B" . embark-bindings))
  :config
  (setq prefix-help-command #'embark-prefix-help-command))

(use-package embark-consult
  :after (embark consult)
  :hook (embark-collect-mode . consult-preview-at-point-mode))
#+end_src

** Consult - Enhanced search/navigation
#+begin_src emacs-lisp
;; xref: use consult for UI and ripgrep for searching
(use-package xref
  :ensure nil
  :defer t
  :custom
  (xref-search-program 'ripgrep)
  :config
  (setq xref-show-xrefs-function       #'consult-xref
        xref-show-definitions-function #'consult-xref))

;; grep: also use rg - consistent with xref and consult-ripgrep
(with-eval-after-load 'grep
  (setq grep-command "rg -nS --no-heading "
        grep-find-ignored-directories
        (append grep-find-ignored-directories
                '("node_modules" "build" "dist"))))

(use-package consult
  :defer t
  :bind (("C-x b"   . consult-buffer)
         ("C-x 4 b" . consult-buffer-other-window)
         ("C-x 5 b" . consult-buffer-other-frame)
         ("C-x r b" . consult-bookmark)
         ("C-x r x" . consult-register)
         ("M-s s"   . consult-find)
         ("M-s /"   . consult-ripgrep)
         ("M-s b"   . consult-buffer)
         ("M-s r"   . consult-recent-file)
         ("M-s l"   . consult-line)
         ("M-s L"   . consult-line-multi)
         ("C-s"     . consult-line)
         ("C-S-s"   . consult-line-multi)
         ("M-y"     . consult-yank-pop)
         ("C-h i"   . consult-info)
         ("C-c m"   . consult-mode-command)
         ("C-c k"   . consult-keep-lines))
  :custom
  (consult-find-args    "find . -not ( -path '*/.git/*' -prune )")
  (consult-ripgrep-args (concat "rg --null --line-buffered --color=never "
                                "--max-columns=1000 --path-separator / "
                                "--smart-case --no-heading --with-filename "
                                "--line-number --search-zip "
                                "--hidden --glob=!.git/"))
  (consult-preview-key  'any)
  (consult-narrow-key   "<"))

;; Dired integration for consult keybindings
(defun my/dired-setup-consult-keys ()
  "Set up consult keybindings for dired mode."
  (define-key dired-mode-map (kbd "M-s s") #'consult-find)
  (define-key dired-mode-map (kbd "M-s /") #'consult-ripgrep)
  (define-key dired-mode-map (kbd "M-s b") #'consult-buffer)
  (define-key dired-mode-map (kbd "M-s r") #'consult-recent-file)
  (when (featurep 'evil)
    (dolist (state '(normal visual motion insert))
      (evil-define-key state dired-mode-map
        (kbd "M-s s") #'consult-find
        (kbd "M-s /") #'consult-ripgrep
        (kbd "M-s b") #'consult-buffer
        (kbd "M-s r") #'consult-recent-file))))

(with-eval-after-load 'dired
  (my/dired-setup-consult-keys)
  (add-hook 'dired-mode-hook #'my/dired-setup-consult-keys t))
#+end_src

** Corfu - In-buffer completion
#+begin_src emacs-lisp
(use-package corfu
  :demand t
  :custom
  (corfu-auto          t)
  (corfu-auto-delay    0.2)
  (corfu-auto-prefix   2)
  (corfu-cycle         t)
  (corfu-separator     ?\s)
  (corfu-quit-at-boundary t)
  (corfu-quit-no-match    t)
  (corfu-preview-current  nil)
  (corfu-preselect        'prompt)
  (corfu-scroll-margin    5)
  :bind (:map corfu-map
         ("TAB"       . corfu-next)
         ("<tab>"     . corfu-next)
         ("S-TAB"     . corfu-previous)
         ("<backtab>" . corfu-previous)
         ("RET"       . corfu-insert)
         ("<return>"  . corfu-insert))
  :config
  (global-corfu-mode)
  (global-set-key (kbd "M-/") #'completion-at-point))

(use-package corfu-popupinfo
  :ensure nil
  :after corfu
  :hook (corfu-mode . corfu-popupinfo-mode)
  :custom
  (corfu-popupinfo-delay '(0.5 . 0.2)))
#+end_src

** Cape - Completion backends
#+begin_src emacs-lisp
(use-package cape
  :defer t
  :init
  (add-to-list 'completion-at-point-functions #'cape-dabbrev)
  (add-to-list 'completion-at-point-functions #'cape-file)
  (add-to-list 'completion-at-point-functions #'cape-elisp-block)
  :config
  (advice-add 'pcomplete-completions-at-point :around #'cape-wrap-silent))
#+end_src

* Compilation
#+begin_src emacs-lisp
;; GCC/Clang errors (file:line:col: error:) are already covered by the
;; built-in `gnu' entry in compilation-error-regexp-alist - no custom
;; regexp needed.

;; Compilation keybindings - Global
(global-set-key (kbd "C-5") #'compile)
(global-set-key (kbd "C-4") #'recompile)

(with-eval-after-load 'evil
  (dolist (state '(normal insert visual motion emacs))
    (evil-define-key state 'global
      (kbd "C-5") #'compile
      (kbd "C-4") #'recompile)))

;; consult-compile-errors: consult interface over the *compilation* buffer.
;; Works without LSP - reads errors parsed by compilation-error-regexp-alist.
;; Use instead of (or alongside) consult-flymake.
(defun my/consult-compile-errors ()
  "Browse compilation errors with consult.
Reads from the current *compilation* buffer using the same error
parser as `next-error' / `M-g n'."
  (interactive)
  (require 'consult)
  (require 'compile)
  (let ((buf (get-buffer "*compilation*")))
    (unless buf
      (user-error "No *compilation* buffer found - run compile first"))
    (let ((candidates '())
          (loc-table (make-hash-table :test 'equal)))
      (with-current-buffer buf
        (goto-char (point-min))
        (while (not (eobp))
          (and-let* ((msg (get-text-property (point) 'compilation-message)))
            (let* ((loc  (compilation--message->loc msg))
                   (type (compilation--message->type msg))
                   (file (caar (compilation--loc->file-struct loc)))
                   (line (compilation--loc->line loc))
                   (col  (compilation--loc->col loc))
                   (text (string-trim
                          (buffer-substring-no-properties
                           (line-beginning-position)
                           (line-end-position))))
                   (face (pcase type
                           (0 'compilation-info)
                           (1 'compilation-warning)
                           (_ 'compilation-error)))
                   (display (format "%-30s %4s:%-4s  %s"
                                    (propertize (or file "?") 'face 'consult-file)
                                    (propertize (number-to-string (or line 0)) 'face 'consult-line-number)
                                    (propertize (number-to-string (or col 0))  'face 'shadow)
                                    (propertize text 'face face))))
              (puthash display (list file line col) loc-table)
              (push display candidates)))
          (forward-line 1)))
      (if (null candidates)
          (message "No errors found in *compilation* buffer")
        (let* ((chosen (consult--read
                        (nreverse candidates)
                        :prompt "Compile error: "
                        :category 'consult-compile-error
                        :sort nil
                        :require-match t))
               (loc  (gethash chosen loc-table))
               (file (nth 0 loc))
               (line (nth 1 loc))
               (col  (nth 2 loc)))
          (when (and file (file-exists-p file))
            (find-file file)
            (goto-char (point-min))
            (forward-line (1- line))
            (when col (move-to-column col))
            (recenter)))))))

(global-set-key (kbd "C-c e") #'my/consult-compile-errors)
(with-eval-after-load 'evil
  (dolist (state '(normal insert visual motion emacs))
    (evil-define-key state 'global (kbd "C-c e") #'my/consult-compile-errors)))
#+end_src

* Project Management
#+begin_src emacs-lisp
;; project.el - built-in, no package needed
;; Custom root detection replicates Projectile's bottom-up marker search
(use-package project
  :ensure nil
  :demand t
  :bind-keymap ("C-x p" . project-prefix-map)
  :bind (:map project-prefix-map
         ("b" . consult-project-buffer))
  :config
  (defun my/project-find-root (dir)
    "Find project root by searching upward for marker files.
Works like Projectile's bottom-up detection - no git required."
    (and-let* ((root (seq-some
                      (lambda (marker)
                        (locate-dominating-file dir marker))
                      '(".git" ".hg" ".projectile"
                        "Makefile" "makefile" "CMakeLists.txt"
                        "compile_commands.json" "go.mod" "package.json"
                        "Cargo.toml" "pyproject.toml" "setup.py"
                        "build.gradle" "pom.xml"))))
      (cons 'transient root)))

  (add-hook 'project-find-functions #'my/project-find-root))
#+end_src

* Dired
#+begin_src emacs-lisp
(use-package dired-hide-dotfiles
  :hook (dired-mode . dired-hide-dotfiles-mode)
  :bind (:map dired-mode-map
         ("." . dired-hide-dotfiles-mode))
  :config
  (with-eval-after-load 'evil
    (evil-define-key 'normal dired-mode-map
      (kbd ".") #'dired-hide-dotfiles-mode)))
#+end_src

* Tree-sitter
#+begin_src emacs-lisp
;; treesit-auto handles mode switching and on-demand grammar installation
(use-package treesit-auto
  :if (and (fboundp 'treesit-available-p) (treesit-available-p))
  :demand t
  :custom
  (treesit-auto-install 'prompt)
  :config
  (global-treesit-auto-mode))
#+end_src

* Programming - LSP & Completion
** DevDocs
#+begin_src emacs-lisp
(use-package devdocs
  :defer t
  :hook ((python-mode     . (lambda () (setq-local devdocs-current-docs '("python~3.12"))))
         (js-mode         . (lambda () (setq-local devdocs-current-docs '("javascript"))))
         (typescript-mode . (lambda () (setq-local devdocs-current-docs '("typescript"))))
         (css-mode        . (lambda () (setq-local devdocs-current-docs '("css"))))
         (html-mode       . (lambda () (setq-local devdocs-current-docs '("html"))))
         (rust-mode       . (lambda () (setq-local devdocs-current-docs '("rust"))))
         (go-mode         . (lambda () (setq-local devdocs-current-docs '("go"))))
         (c-mode          . (lambda () (setq-local devdocs-current-docs '("c"))))
         (c++-mode        . (lambda () (setq-local devdocs-current-docs '("cpp"))))
         (ruby-mode       . (lambda () (setq-local devdocs-current-docs '("ruby~3.3")))))
  :bind (("M-s d d" . devdocs-lookup)
         ("M-s d i" . devdocs-install)
         ("M-s d s" . devdocs-search))
  :config
  (defun my/devdocs-or-fallback ()
    "Try devdocs-lookup, fall back to evil's default K."
    (interactive)
    (if devdocs-current-docs
        (devdocs-lookup nil (thing-at-point 'symbol t))
      (evil-lookup)))
  (with-eval-after-load 'evil
    (evil-define-key 'normal 'global (kbd "K") #'my/devdocs-or-fallback)))
#+end_src

** Dumb-jump - Code navigation without LSP
#+begin_src emacs-lisp
(use-package dumb-jump
  :demand t
  :init
  ;; 'append = runs AFTER Eglot so it's a fallback when LSP finds nothing
  (add-hook 'xref-backend-functions #'dumb-jump-xref-activate 'append)
  :custom
  (dumb-jump-force-searcher  'rg)
  (dumb-jump-default-project "~/projects")
  (dumb-jump-selector        'completing-read)
  ;; aggressive nil = only search in project, not everywhere
  (dumb-jump-aggressive      nil)
  (dumb-jump-max-find-time   10)
  :config
  ;; Remove etags to prevent TAGS file errors
  (remove-hook 'xref-backend-functions #'etags--xref-backend)

  ;; When Eglot is active it errors instead of returning nil when it can't
  ;; find a definition, which prevents dumb-jump from getting a chance.
  ;; This advice catches that and falls through to the next xref backend.
  (defun my/xref-find-definitions-fallback (orig-fn identifier)
    "Try ORIG-FN, fall back to dumb-jump if it returns nil or errors."
    (condition-case nil
        (let ((result (funcall orig-fn identifier)))
          (if (and result (not (null result)))
              result
            (dumb-jump-go)))
      (error (dumb-jump-go))))
  (advice-add 'xref-find-definitions :around #'my/xref-find-definitions-fallback)

  ;; Must be set in :config so defcustom doesn't clobber it after load
  (setq dumb-jump-project-denoters
        '(".git" ".hg"
          "makefile" "Makefile" "CMakeLists.txt"
          "compile_commands.json" "go.mod" "package.json"
          "Cargo.toml" "pyproject.toml" "setup.py"))

  (add-to-list 'dumb-jump-language-file-exts
               '(:language "c"   :ext "h"   :agtype "cc" :rgtype "c"))
  (add-to-list 'dumb-jump-language-file-exts
               '(:language "c++" :ext "hpp" :agtype "cc" :rgtype "cpp"))
  (add-to-list 'dumb-jump-language-file-exts
               '(:language "c++" :ext "hh"  :agtype "cc" :rgtype "cpp"))

  ;; Larger ring prevents dumb-jump's double-push from landing at history start
  (setq xref-marker-ring-length 16)

  ;; Force dumb-jump explicitly (bypassing LSP)
  (global-set-key (kbd "C-M-g") #'dumb-jump-go)
  (global-set-key (kbd "C-M-p") #'dumb-jump-back)
  (global-set-key (kbd "C-M-j") #'dumb-jump-go-prompt)

  (with-eval-after-load 'evil
    (dolist (state '(normal insert visual motion emacs))
      (evil-define-key state 'global
        (kbd "M-.") #'xref-find-definitions
        (kbd "M-,") #'xref-go-back)))

  ;; NOTE: evil's C-o (back) / C-i (forward) are more reliable than M-,
  ;; for navigating after dumb-jump since they use evil's own jump list
  ;; instead of xref's marker ring.
  )

;; Direct search in /usr/include
(defun my/search-system-headers ()
  "Search for symbol at point in /usr/include system headers."
  (interactive)
  (let ((dumb-jump-default-project  "/usr/include")
        (dumb-jump-project-denoters nil))
    (message "Searching /usr/include...")
    (dumb-jump-go)))

;; Find a header FILE by name in /usr/include
(defun my/find-system-header-file ()
  "Find a header file by name in /usr/include.
Uses region if active, otherwise word at point (adds .h if no extension)."
  (interactive)
  (let* ((raw (if (use-region-p)
                  (buffer-substring-no-properties (region-beginning) (region-end))
                (thing-at-point 'filename t)))
         (name (if (and raw (string-match-p "\\." raw)) raw (concat raw ".h")))
         (results (split-string
                   (shell-command-to-string
                    (format "find /usr/include -name '%s' 2>/dev/null" name))
                   "\n" t)))
    (cond
     ((null results)
      (message "No header file found for: %s" name))
     ((= 1 (length results))
      (find-file (car results)))
     (t
      (find-file (completing-read (format "Find header (%s): " name) results nil t))))))

(global-set-key (kbd "M-s h") #'my/search-system-headers)
(global-set-key (kbd "M-s H") #'my/find-system-header-file)

;; Keybinding reference:
;; M-. / g d    → Smart jump (LSP → dumb-jump fallback)
;; M-, / g b    → Go back
;; C-M-g        → Force dumb-jump (bypass LSP)
;; C-M-j        → Prompt for custom search directory
;; M-s h        → Search for symbol in /usr/include
;; M-s H        → Find header FILE by name in /usr/include
#+end_src

** Eglot LSP
#+begin_src emacs-lisp
;; Always available, even before eglot loads
(global-set-key (kbd "C-c l l") #'eglot)

(use-package eglot
  :ensure nil
  :defer t
  :bind (:map eglot-mode-map
         ("C-c l a" . eglot-code-actions)
         ("C-c l r" . eglot-rename)
         ("C-c l f" . eglot-format)
         ("C-c l d" . eglot-find-declaration)
         ("C-c l i" . eglot-find-implementation)
         ("C-c l t" . eglot-find-typeDefinition)
         ("C-c l h" . eldoc-doc-buffer)
         ("C-c l s" . eglot-reconnect))
  :custom
  (eglot-events-buffer-size 0)    ; Disable event logging
  (eglot-sync-connect       nil)  ; Async connection
  :config
  (add-to-list 'eglot-server-programs
               '((js-mode js-ts-mode typescript-mode typescript-ts-mode tsx-ts-mode)
                 . ("typescript-language-server" "--stdio"))))
#+end_src

** Apheleia - Format on save
#+begin_src emacs-lisp
;; Apheleia - async format on save, works with or without Eglot
;; System deps: pacman -S clang   (C/C++)
;;              pip install black  (Python)
;;              npm install -g prettier  (JS/TS)
;;              gofmt ships with Go
(use-package apheleia
  :ensure t
  :demand t
  :hook (prog-mode . apheleia-mode)
  :config
  ;; Explicit formatter assignments for our languages
  (setf (alist-get 'c-mode      apheleia-mode-alist) 'clang-format)
  (setf (alist-get 'c-ts-mode   apheleia-mode-alist) 'clang-format)
  (setf (alist-get 'c++-mode    apheleia-mode-alist) 'clang-format)
  (setf (alist-get 'c++-ts-mode apheleia-mode-alist) 'clang-format)
  (setf (alist-get 'python-mode     apheleia-mode-alist) 'black)
  (setf (alist-get 'python-ts-mode  apheleia-mode-alist) 'black)
  (setf (alist-get 'go-mode         apheleia-mode-alist) 'gofmt)
  (setf (alist-get 'go-ts-mode      apheleia-mode-alist) 'gofmt)
  (setf (alist-get 'js-mode         apheleia-mode-alist) 'prettier)
  (setf (alist-get 'js-ts-mode      apheleia-mode-alist) 'prettier)
  (setf (alist-get 'typescript-mode    apheleia-mode-alist) 'prettier)
  (setf (alist-get 'typescript-ts-mode apheleia-mode-alist) 'prettier)
  (setf (alist-get 'tsx-ts-mode     apheleia-mode-alist) 'prettier)
  (setf (alist-get 'yaml-mode       apheleia-mode-alist) 'prettier)
  (setf (alist-get 'json-mode       apheleia-mode-alist) 'prettier))
#+end_src


#+begin_src emacs-lisp
(use-package go-mode         :defer t :mode "\\.go\\'")
(use-package typescript-mode :defer t
  :mode (("\\.ts\\'"  . typescript-mode)
         ("\\.tsx\\'" . tsx-ts-mode)))
(use-package json-mode       :defer t :mode "\\.json\\'")
(use-package yaml-mode       :defer t :mode "\\.ya?ml\\'")
(use-package terraform-mode  :defer t :mode "\\.tf\\'")
(use-package dockerfile-mode :defer t :mode "Dockerfile\\'")

;; Kubernetes & Helm YAML files
(dolist (pattern '("\\.k8s\\.ya?ml\\'"
                   "k8s/.*\\.ya?ml\\'"
                   "Chart\\.yaml\\'"
                   "values\\.yaml\\'"
                   "templates/.*\\.yaml\\'"
                   "templates/.*\\.tpl\\'"))
  (add-to-list 'auto-mode-alist `(,pattern . yaml-mode)))
#+end_src

* Debugging with Dape
#+begin_src emacs-lisp
(use-package dape
  :defer t
  :bind (("C-c d d" . dape)
         ("C-c d p" . dape-pause)
         ("C-c d c" . dape-continue)
         ("C-c d n" . dape-next)
         ("C-c d s" . dape-step-in)
         ("C-c d o" . dape-step-out)
         ("C-c d r" . dape-restart)
         ("C-c d k" . dape-kill)
         ("C-c d q" . dape-quit)
         ("C-c d b" . dape-breakpoint-toggle)
         ("C-c d l" . dape-breakpoint-log)
         ("C-c d e" . dape-breakpoint-expression)
         ("C-c d w" . dape-watch-dwim)
         ("C-c d i" . dape-info)
         ("C-c d R" . dape-repl))
  :hook
  (dape-on-start      . (lambda () (save-some-buffers t t)))
  (dape-compile-compile . kill-buffer)
  :custom
  (dape-cwd-fn 'dape--default-cwd)
  :config
  ;; Python (debugpy) - install: pip install debugpy
  (add-to-list 'dape-configs
               `(debugpy
                 modes (python-mode python-ts-mode)
                 command "python"
                 command-args ("-m" "debugpy.adapter")
                 :request "launch"
                 :type "executable"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))

  ;; Go (delve) - install: go install github.com/go-delve/delve/cmd/dlv@latest
  (add-to-list 'dape-configs
               `(delve
                 modes (go-mode go-ts-mode)
                 command "dlv"
                 command-args ("dap" "--listen" "127.0.0.1:55878")
                 command-cwd dape-cwd-fn
                 port 55878
                 :request "launch"
                 :type "debug"
                 :mode "debug"
                 :program dape-cwd-fn))

  ;; C/C++ via GDB
  (add-to-list 'dape-configs
               `(gdb
                 modes (c-mode c++-mode c-ts-mode c++-ts-mode)
                 command "gdb"
                 command-args ("-i" "dap")
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "executable"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))

  ;; C/C++ via LLDB (alternative to GDB)
  (add-to-list 'dape-configs
               `(lldb
                 modes (c-mode c++-mode c-ts-mode c++-ts-mode)
                 command "lldb-vscode"
                 command-args ()
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "lldb"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default))

  ;; Node.js (JavaScript / TypeScript)
  (add-to-list 'dape-configs
               `(node
                 modes (js-mode js-ts-mode typescript-mode typescript-ts-mode)
                 command "node"
                 command-args ("--inspect-brk" dape-buffer-default)
                 command-cwd dape-cwd-fn
                 :request "launch"
                 :type "node"
                 :cwd dape-cwd-fn
                 :program dape-buffer-default)))
#+end_src

* Org Mode
#+begin_src emacs-lisp
(use-package org
  :ensure nil
  :defer t
  :hook (org-mode . (lambda ()
                      (org-indent-mode)
                      (visual-line-mode)))
  :bind (:map org-mode-map
         ("C-c C-c" . org-ctrl-c-ctrl-c)
         ("C-c '"   . org-edit-special))
  :custom
  (org-startup-indented             t)
  (org-hide-leading-stars           nil)
  (org-startup-folded               'content)
  (org-src-fontify-natively         t)
  (org-src-tab-acts-natively        t)
  (org-confirm-babel-evaluate       nil)
  (org-edit-src-content-indentation 0)
  (org-src-preserve-indentation     t)
  (org-src-window-setup             'current-window)
  (org-cycle-separator-lines        2)
  :config
  ;; Babel languages - loaded on first org-mode use, not at startup
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (python . t)
     (C . t)
     (shell . t)
     (js . t)))

  ;; Enable eglot in org-src edit buffers
  (defun my/org-babel-edit-prep (info)
    "Enable eglot in org src blocks by setting buffer-file-name."
    (setq buffer-file-name (or (alist-get :file (caddr info))
                               "org-src-babel-tmp"))
    (when (derived-mode-p 'prog-mode)
      (eglot-ensure)))

  (advice-add 'org-edit-src-code
              :before
              (defun my/org-edit-src-code-advice (&rest _args)
                (and-let* ((element   (org-element-at-point))
                           (lang      (org-element-property :language element))
                           (mode      (org-src-get-lang-mode lang))
                           ((eglot--lookup-mode mode))
                           (edit-prep (intern (format "org-babel-edit-prep:%s" lang))))
                  (unless (fboundp edit-prep)
                    (fset edit-prep #'my/org-babel-edit-prep)))))

  (custom-set-faces
   '(org-level-1        ((t (:height 1.3 :weight bold))))
   '(org-level-2        ((t (:height 1.2 :weight semi-bold))))
   '(org-level-3        ((t (:height 1.1 :weight semi-bold))))
   '(org-document-title ((t (:height 1.5 :weight bold))))))

;; Org-modern
(use-package org-modern
  :defer t
  :hook ((org-mode            . org-modern-mode)
         (org-agenda-finalize . org-modern-agenda))
  :custom
  (org-modern-hide-stars   nil)
  (org-modern-table        nil)
  (org-modern-block-fringe nil)
  (org-modern-checkbox
   '((?X  . "☑")
     (?-  . "⊟")
     (?\s . "☐")))
  (org-modern-tag        t)
  (org-modern-priority   t)
  (org-modern-keyword    t)
  (org-modern-timestamp  t)
  (org-modern-statistics t)
  (org-modern-block-name t)
  (org-modern-list
   '((?+ . "◦")
     (?- . "–")
     (?* . "•")))
  :config
  (global-org-modern-mode))
#+end_src

* Terminal
#+begin_src emacs-lisp
(use-package vterm
  :defer t
  :custom
  (vterm-always-compile-module      t)
  (vterm-max-scrollback             10000)
  (vterm-term-environment-variable  "xterm-256color")
  :config
  (evil-set-initial-state 'vterm-mode 'emacs)
  (defun my/vterm-setup-colors ()
    "Set vterm colors to match Menudo theme."
    (setq vterm-color-black          "#000000"
          vterm-color-red            "#dc322f"
          vterm-color-green          "#66bc11"
          vterm-color-yellow         "#b58900"
          vterm-color-blue           "#268bd2"
          vterm-color-magenta        "#af87d7"
          vterm-color-cyan           "#5fafaf"
          vterm-color-white          "#cccccc"
          vterm-color-bright-black   "#666666"
          vterm-color-bright-red     "#dc7575"
          vterm-color-bright-green   "#66bc11"
          vterm-color-bright-yellow  "#f0bb0c"
          vterm-color-bright-blue    "#268bd2"
          vterm-color-bright-magenta "#af87d7"
          vterm-color-bright-cyan    "#5fafaf"
          vterm-color-bright-white   "#cccccc"))
  (add-hook 'vterm-mode-hook #'my/vterm-setup-colors))
#+end_src

* Visual Enhancements
#+begin_src emacs-lisp
(use-package rainbow-delimiters
  :defer t
  :hook (prog-mode . rainbow-delimiters-mode))
#+end_src

* Version Control
#+begin_src emacs-lisp
(use-package magit
  :defer t
  :bind ("C-x g" . magit-status)
  :custom
  (magit-diff-refine-hunk 'all))

(use-package diff-hl
  :defer t
  :hook ((prog-mode          . diff-hl-mode)
         (org-mode           . diff-hl-mode)
         (dired-mode         . diff-hl-dired-mode)
         (magit-post-refresh . diff-hl-magit-post-refresh)))
#+end_src

* Built-in Package Improvements
#+begin_src emacs-lisp
;; Uniquify - sensible duplicate buffer names (project/file.c instead of file.c<2>)
(use-package uniquify
  :ensure nil
  :config
  (setq uniquify-buffer-name-style  'forward
        uniquify-strip-common-suffix t
        uniquify-after-kill-buffer-p t))

;; Eldoc - better defaults, composes multiple sources (useful with Eglot)
(use-package eldoc
  :ensure nil
  :custom
  (eldoc-echo-area-use-multiline-p    nil)  ; keep echo area single line
  (eldoc-echo-area-prefer-doc-buffer  t)    ; prefer *eldoc* buffer over echo area
  (eldoc-documentation-strategy       'eldoc-documentation-compose)
  :config
  (global-eldoc-mode))

;; Eldoc backends for use WITHOUT Eglot/LSP
;; When Eglot is active it replaces these automatically.

;; Python - argument signatures via python's inspect module, no LSP needed
;; Uses the running Python process so it reflects the actual installed packages.
(use-package python-eldoc
  :ensure nil  ; built into python.el
  :hook ((python-mode    . python-eldoc-setup)
         (python-ts-mode . python-eldoc-setup)))

;; Go - eldoc via godef, no LSP needed
;; Requires: go install github.com/rogpeppe/godef@latest
(use-package go-eldoc
  :hook ((go-mode    . go-eldoc-setup)
         (go-ts-mode . go-eldoc-setup)))

;; Isearch - match counter + M-w to copy current match
(use-package isearch
  :ensure nil
  :custom
  (isearch-lazy-count      t)
  (lazy-count-prefix-format "(%s/%s) ")
  (lazy-count-suffix-format nil)
  (search-whitespace-regexp ".*?")  ; make space match anything (fuzzy)
  :config
  (defun my/isearch-copy-match ()
    "Copy the current isearch match to the kill ring and exit.
Pair with M-s M-. to search+copy the word under point."
    (interactive)
    (when isearch-other-end
      (kill-new (buffer-substring-no-properties isearch-other-end (point)))
      (isearch-exit)))
  (define-key isearch-mode-map (kbd "M-w") #'my/isearch-copy-match))

;; Smerge - git merge conflict resolution keybindings
(use-package smerge-mode
  :ensure nil
  :defer t
  :bind (:map smerge-mode-map
         ("C-c C-s C-u" . smerge-keep-upper)
         ("C-c C-s C-l" . smerge-keep-lower)
         ("C-c C-s C-n" . smerge-next)
         ("C-c C-s C-p" . smerge-prev)))

;; Proced - Emacs process manager (like top, but better integrated)
(use-package proced
  :ensure nil
  :defer t
  :custom
  (proced-enable-color-flag    t)
  (proced-tree-flag            t)       ; show process tree
  (proced-auto-update-flag     'visible)
  (proced-auto-update-interval 2)       ; every 2s (1s is aggressive)
  (proced-descent              t)
  (proced-filter               'user)   ; show only your processes; change with 'f'
  :hook
  (proced-mode . (lambda () (proced-toggle-auto-update 1))))
#+end_src

* Custom Functions
** Project Navigation and Management
*** Directory Candidates Helper
#+begin_src emacs-lisp
(defvar my/directory-history nil
  "History for directory selection.")

(defvar my/base-directories '("~/projects" "~/exercism" "~/.config" "~")
  "Base directories to scan for projects.")

(defun my/get-directory-candidates ()
  "Get list of directories from common project locations."
  (let (dirs)
    (dolist (base-dir my/base-directories)
      (let ((expanded (expand-file-name base-dir)))
        (when (file-directory-p expanded)
          (push expanded dirs)
          (dolist (subdir (directory-files expanded t
                                           directory-files-no-dot-files-regexp t))
            (when (file-directory-p subdir)
              (push subdir dirs))))))
    (nreverse dirs)))
#+end_src

*** Consult-Based Navigation (Integrated with project.el)
#+begin_src emacs-lisp
(defun my/consult-sessionizer ()
  "Consult-based directory selection from custom folders.
Opens selected directory in dired and registers it with project.el."
  (interactive)
  (require 'consult)
  (let ((candidates (my/get-directory-candidates)))
    (if (not candidates)
        (progn (dired default-directory)
               (message "No project directories found. Opened current directory."))
      (and-let* ((selected
                  (consult--read candidates
                                 :prompt "Select directory: "
                                 :require-match t
                                 :sort nil
                                 :category 'file
                                 :history 'my/directory-history)))
        (dired selected)
        ;; Register with project.el so it appears in C-x p p
        (project-remember-project
         (project-current nil selected))
        (message "Opened: %s" selected)))))
#+end_src

*** Project Creation
#+begin_src emacs-lisp
(defun my/git-init-and-commit (project-dir project-name)
  "Initialize git repo in PROJECT-DIR with an initial commit."
  (let ((default-directory project-dir))
    (call-process "git" nil nil nil "init" "-b" "main")
    (with-temp-file (expand-file-name "README.md" project-dir)
      (insert (format "# %s\n\nProject description\n" project-name)))
    (call-process "git" nil nil nil "add" "README.md")
    (call-process "git" nil nil nil "commit" "-m" "initial commit")))

(defun my/create-github-repo (project-name visibility)
  "Create a GitHub repository for PROJECT-NAME with VISIBILITY flag."
  (call-process-shell-command
   (format "gh repo create %s %s --source=. --remote=origin --push"
           project-name visibility)))

(defun my/create-new-project ()
  "Create a new project directory with git and optional GitHub repo."
  (interactive)
  (let* ((project-name (string-trim (read-string "Project name: ")))
         (project-dir  (expand-file-name project-name "~/projects")))
    (when (string-empty-p project-name)
      (user-error "Project name cannot be empty"))
    (make-directory project-dir t)
    (unless (file-exists-p (expand-file-name ".git" project-dir))
      (my/git-init-and-commit project-dir project-name)
      (when (and (executable-find "gh")
                 (y-or-n-p "Create GitHub repository? "))
        (my/create-github-repo project-name
                               (if (y-or-n-p "Public repository? ")
                                   "--public" "--private"))))
    (dired project-dir)))
#+end_src

*** GitHub PR Helper
#+begin_src emacs-lisp
(defun my/get-git-info ()
  "Return (remote-url . branch) for the current repo, or nil."
  (when (locate-dominating-file default-directory ".git")
    (let ((remote (string-trim (shell-command-to-string
                                "git config --get remote.origin.url")))
          (branch (string-trim (shell-command-to-string
                                "git rev-parse --abbrev-ref HEAD"))))
      (when (and (not (string-empty-p remote))
                 (not (string-empty-p branch)))
        (cons remote branch)))))

(defun my/convert-to-github-url (remote-url)
  "Convert git REMOTE-URL to a GitHub HTTPS URL."
  (cond
   ((string-match "^git@github\\.com:\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   ((string-match "^https://github\\.com/\\(.+?\\)\\(?:\\.git\\)?$" remote-url)
    (concat "https://github.com/" (match-string 1 remote-url)))
   (t (error "Not a GitHub repository: %s" remote-url))))

(defun my/open-github-pr ()
  "Open the GitHub compare page for the current branch."
  (interactive)
  (if-let* ((git-info   (my/get-git-info)))
      (and-let* ((github-url (my/convert-to-github-url (car git-info)))
                 (branch     (cdr git-info)))
        (browse-url (concat github-url "/compare/" branch)))
    (user-error "Not in a git repository")))
#+end_src

*** Keybindings
#+begin_src emacs-lisp
(global-set-key (kbd "C-c p s") #'my/consult-sessionizer)
(global-set-key (kbd "C-c p n") #'my/create-new-project)
(global-set-key (kbd "C-c p r") #'my/open-github-pr)

(with-eval-after-load 'evil
  (dolist (state '(normal insert visual motion emacs))
    (evil-define-key state 'global
      (kbd "C-S-f") #'my/consult-sessionizer
      (kbd "C-S-n") #'my/create-new-project
      (kbd "C-S-p") #'my/open-github-pr)))
#+end_src

* Performance Optimizations
#+begin_src emacs-lisp
;; GC threshold is managed in early-init.el / emacs-startup-hook.

;; Increase subprocess read buffer (critical for LSP performance)
(setq read-process-output-max (* 1024 1024))  ; 1 MB

;; Skip font lock on input to reduce rendering overhead
(setq redisplay-skip-fontification-on-input t)

;; Collect garbage only when Emacs is idle, not mid-typing
(run-with-idle-timer 5 t #'garbage-collect)
#+end_src
